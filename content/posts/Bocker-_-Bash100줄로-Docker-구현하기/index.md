---
title: "Bocker : Bash100ì¤„ë¡œ Docker êµ¬í˜„í•˜ê¸°"
date: 2025-03-04T00:36:00.000Z
draft: false
tags: ["Docker"]
series: ["Infra & Network"]
description: "BockerëŠ” ì•½ 100ì¤„ì˜ ë°°ì‰¬ë¡œ êµ¬í˜„ëœ Dockerë¡œ, Btrfs, ë„¤ì„ìŠ¤í˜ì´ìŠ¤, cgroupsì™€ ê°™ì€ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ê¸°ëŠ¥ì„ í™œìš©í•˜ì—¬ ê²½ëŸ‰ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤. ì£¼ìš” ê¸°ëŠ¥ìœ¼ë¡œëŠ” ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ, ì»¨í…Œì´ë„ˆ ì‹¤í–‰, ë¡œê·¸ í™•ì¸, ë¦¬ì†ŒìŠ¤ ì œí•œ ì„¤ì • ë“±ì´ ìˆìœ¼ë©°, ì‚¬ìš©ìëŠ” bocker pull, bocker run, bocker commit ë“±ì˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ í”„ë¡œì íŠ¸ëŠ” ë‹¨ìˆœí•œ êµ¬í˜„ì„ ëª©í‘œë¡œ í•˜ë©°, ì‚¬ìš© í¸ì˜ì„±ì„ ìœ„í•´ í•„ìš”í•œ í™˜ê²½ì„ êµ¬ì¶•í•  ìˆ˜ ìˆëŠ” Vagrant íŒŒì¼ë„ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
notion_id: "1ac1bab9-e3f8-806d-909c-e15171c5918a"
notion_url: "https://www.notion.so/Bocker-Bash100-Docker-1ac1bab9e3f8806d909ce15171c5918a"
---

# Bocker : Bash100ì¤„ë¡œ Docker êµ¬í˜„í•˜ê¸°

> **Summary**
> BockerëŠ” ì•½ 100ì¤„ì˜ ë°°ì‰¬ë¡œ êµ¬í˜„ëœ Dockerë¡œ, Btrfs, ë„¤ì„ìŠ¤í˜ì´ìŠ¤, cgroupsì™€ ê°™ì€ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ê¸°ëŠ¥ì„ í™œìš©í•˜ì—¬ ê²½ëŸ‰ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤. ì£¼ìš” ê¸°ëŠ¥ìœ¼ë¡œëŠ” ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ, ì»¨í…Œì´ë„ˆ ì‹¤í–‰, ë¡œê·¸ í™•ì¸, ë¦¬ì†ŒìŠ¤ ì œí•œ ì„¤ì • ë“±ì´ ìˆìœ¼ë©°, ì‚¬ìš©ìëŠ” bocker pull, bocker run, bocker commit ë“±ì˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ í”„ë¡œì íŠ¸ëŠ” ë‹¨ìˆœí•œ êµ¬í˜„ì„ ëª©í‘œë¡œ í•˜ë©°, ì‚¬ìš© í¸ì˜ì„±ì„ ìœ„í•´ í•„ìš”í•œ í™˜ê²½ì„ êµ¬ì¶•í•  ìˆ˜ ìˆëŠ” Vagrant íŒŒì¼ë„ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

---

![Image](image_a9c7d04d9317.png)

ğŸ”— [https://github.com/Cybecho/bocker](https://github.com/Cybecho/bocker)

> ê¸°ì¡´ Bocker í”„ë¡œì íŠ¸ë¥¼ ë‹¨ìˆœíˆ ë²ˆì—­í•˜ê³ , ì„¤ëª…ì„ ì¶”ê°€í•œ ë ˆíŒŒí† ì§€ì…ë‹ˆë‹¤. ì„¤ëª…ì´ í‹€ë ¸ì„ ê°€ëŠ¥ì„±ì´ ì¡´ì¬í•˜ë‹ˆ, ì´ì  ê°ì•ˆí•˜ê³  ì°¸ê³ ë§Œ í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.

**Bocker**

ì•½ 100ì¤„ì˜ ë°°ì‰¬ë¡œ êµ¬í˜„ëœ Docker.

- [Bocker](https://github.com/Cybecho/bocker#bocker)
  - [ì „ì œ ì¡°ê±´](https://github.com/Cybecho/bocker#%EC%A0%84%EC%A0%9C-%EC%A1%B0%EA%B1%B4)
  - [ì‚¬ìš© ì˜ˆì‹œ](https://github.com/Cybecho/bocker#%EC%82%AC%EC%9A%A9-%EC%98%88%EC%8B%9C)
  - [ê¸°ëŠ¥: í˜„ì¬ êµ¬í˜„ë¨](https://github.com/Cybecho/bocker#%EA%B8%B0%EB%8A%A5-%ED%98%84%EC%9E%AC-%EA%B5%AC%ED%98%84%EB%90%A8)
  - [ê¸°ëŠ¥ì„ ë§¤ìš° ì œí•œì ìœ¼ë¡œ êµ¬í˜„ë˜ì–´ìˆìŠµë‹ˆë‹¤: ì•„ì§ êµ¬í˜„ë˜ì§€ ì•ŠìŒ](https://github.com/Cybecho/bocker#%EA%B8%B0%EB%8A%A5%EC%9D%84-%EB%A7%A4%EC%9A%B0-%EC%A0%9C%ED%95%9C%EC%A0%81%EC%9C%BC%EB%A1%9C-%EA%B5%AC%ED%98%84%EB%90%98%EC%96%B4%EC%9E%88%EC%8A%B5%EB%8B%88%EB%8B%A4-%EC%95%84%EC%A7%81-%EA%B5%AC%ED%98%84%EB%90%98%EC%A7%80-%EC%95%8A%EC%9D%8C)
  - [Bockerì˜ í•µì‹¬ ì»¨í…Œì´ë„ˆ ê¸°ìˆ  ë™ì‘ ì›ë¦¬](https://github.com/Cybecho/bocker#bocker%EC%9D%98-%ED%95%B5%EC%8B%AC-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EA%B8%B0%EC%88%A0-%EB%8F%99%EC%9E%91-%EC%9B%90%EB%A6%AC)
    - [ì»¨í…Œì´ë„ˆ ê²©ë¦¬ êµ¬í˜„ ë°©ì‹](https://github.com/Cybecho/bocker#%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EA%B2%A9%EB%A6%AC-%EA%B5%AC%ED%98%84-%EB%B0%A9%EC%8B%9D)
    - [ì»¨í…Œì´ë„ˆ ë¼ì´í”„ì‚¬ì´í´ ê´€ë¦¬](https://github.com/Cybecho/bocker#%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EB%9D%BC%EC%9D%B4%ED%94%84%EC%82%AC%EC%9D%B4%ED%81%B4-%EA%B4%80%EB%A6%AC)
    - [ê·¸ ì™¸ êµ¬í˜„](https://github.com/Cybecho/bocker#%EA%B7%B8-%EC%99%B8-%EA%B5%AC%ED%98%84)
  - [ê° í•¨ìˆ˜ ì„¤ëª…](https://github.com/Cybecho/bocker#%EA%B0%81-%ED%95%A8%EC%88%98-%EC%84%A4%EB%AA%85)
    - [ì´ˆê¸° ì„¤ì •ê³¼ ê¸°ë³¸ êµ¬ì¡°](https://github.com/Cybecho/bocker#%EC%B4%88%EA%B8%B0-%EC%84%A4%EC%A0%95%EA%B3%BC-%EA%B8%B0%EB%B3%B8-%EA%B5%AC%EC%A1%B0)
    - [ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤](https://github.com/Cybecho/bocker#%EA%B8%B0%ED%83%80-%EC%9C%A0%ED%8B%B8%EB%A6%AC%ED%8B%B0-%ED%95%A8%EC%88%98%EB%93%A4)
      - [ì „ì²´ ì›Œí¬í”Œë¡œìš° ìš”ì•½](https://github.com/Cybecho/bocker#%EC%A0%84%EC%B2%B4-%EC%9B%8C%ED%81%AC%ED%94%8C%EB%A1%9C%EC%9A%B0-%EC%9A%94%EC%95%BD)
  - [License](https://github.com/Cybecho/bocker#license)
**ì „ì œ ì¡°ê±´**

bockerë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ ë‹¤ìŒ íŒ¨í‚¤ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.

- btrfs-progs
- curl
- iproute2
- iptables
- libcgroup-tools
- util-linux >= 2.25.2
- coreutils >= 7.5
ëŒ€ë¶€ë¶„ì˜ ë°°í¬íŒì—ëŠ” ì¶©ë¶„íˆ ìƒˆë¡œìš´ ë²„ì „ì˜ ìœ í‹¸ë¦¬í‹° ë¦¬ëˆ…ìŠ¤ê°€ ì œê³µë˜ì§€ ì•Šìœ¼ë¯€ë¡œÂ [ì—¬ê¸°](https://www.kernel.org/pub/linux/utils/util-linux/v2.25/)ì—ì„œ ì†ŒìŠ¤ë¥¼ ê°€ì ¸ì™€ ì§ì ‘ ì»´íŒŒì¼í•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ ì‹œìŠ¤í…œì„ ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤:

- ì•„ë˜ì— ë§ˆìš´íŠ¸ëœ btrfs íŒŒì¼ ì‹œìŠ¤í…œÂ `/var/bocker`
- 'bridge0'ì´ë¼ëŠ” ë„¤íŠ¸ì›Œí¬ ë¸Œë¦¬ì§€ ë° 10.0.0.1/24ì˜ IP.
- IP í¬ì›Œë”©ì´Â `/proc/sys/net/ipv4/ip_forward`ì—ì„œ í™œì„±í™”ëœ ê²½ìš°
- 'bridge0'ì—ì„œ ë¬¼ë¦¬ì  ì¸í„°í˜ì´ìŠ¤ë¡œ íŠ¸ë˜í”½ì„ ë¼ìš°íŒ…í•˜ëŠ” ë°©í™”ë²½.
ì‚¬ìš© í¸ì˜ì„±ì„ ìœ„í•´ í•„ìš”í•œ í™˜ê²½ì„ êµ¬ì¶•í•  ìˆ˜ ìˆëŠ” VagrantíŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ìœ„ì˜ ì „ì œ ì¡°ê±´ì„ ì¶©ì¡±í•˜ë”ë¼ë„ ê°€ìƒ ë¨¸ì‹ ì—ì„œÂ **ë³´ì»¤ë¥¼ ì‹¤í–‰**í•˜ê³  ì‹¶ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. BockerëŠ” ë£¨íŠ¸ë¡œ ì‹¤í–‰ë˜ë©° ë¬´ì—‡ë³´ë‹¤ë„ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤, ë¼ìš°íŒ… í…Œì´ë¸” ë° ë°©í™”ë²½ ê·œì¹™ì„ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.Â **ì‹œìŠ¤í…œì„ ì—‰ë§ìœ¼ë¡œ ë§Œë“¤ì§€ ì•ŠëŠ”ë‹¤ëŠ” ë³´ì¥ì€ ì—†ìŠµë‹ˆë‹¤**.

**ì‚¬ìš© ì˜ˆì‹œ**

```plain text
$ bocker pull centos 7
######################################################################## 100.0%
######################################################################## 100.0%
######################################################################## 100.0%
Created: img_42150

$ bocker images
IMAGE_ID        SOURCE
img_42150       centos:7

$ bocker run img_42150 cat /etc/centos-release
CentOS Linux release 7.1.1503 (Core)

$ bocker ps
CONTAINER_ID       COMMAND
ps_42045           cat /etc/centos-release

$ bocker logs ps_42045
CentOS Linux release 7.1.1503 (Core)

$ bocker rm ps_42045
Removed: ps_42045

$ bocker run img_42150 which wget
which: no wget in (/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin)

$ bocker run img_42150 yum install -y wget
Installing : wget-1.14-10.el7_0.1.x86_64                                  1/1
Verifying  : wget-1.14-10.el7_0.1.x86_64                                  1/1
Installed  : wget.x86_64 0:1.14-10.el7_0.1
Complete!

$ bocker ps
CONTAINER_ID       COMMAND
ps_42018           yum install -y wget
ps_42182           which wget

$ bocker commit ps_42018 img_42150
Removed: img_42150
Created: img_42150

$ bocker run img_42150 which wget
/usr/bin/wget

$ bocker run img_42150 cat /proc/1/cgroup
...
4:memory:/ps_42152
3:cpuacct,cpu:/ps_42152

$ cat /sys/fs/cgroup/cpu/ps_42152/cpu.shares
512

$ cat /sys/fs/cgroup/memory/ps_42152/memory.limit_in_bytes
512000000

$ BOCKER_CPU_SHARE=1024 \
	BOCKER_MEM_LIMIT=1024 \
	bocker run img_42150 cat /proc/1/cgroup
...
4:memory:/ps_42188
3:cpuacct,cpu:/ps_42188

$ cat /sys/fs/cgroup/cpu/ps_42188/cpu.shares
1024

$ cat /sys/fs/cgroup/memory/ps_42188/memory.limit_in_bytes
1024000000

```

**ê¸°ëŠ¥: í˜„ì¬ êµ¬í˜„ë¨**

- `docker build`Â â€ 
- `docker pull`
- `docker images`
- `docker ps`
- `docker run`
- `docker exec`
- `docker logs`
- `docker commit`
- `docker rm`Â /Â `docker rmi`
- Networking
- Quota Support / CGroups
'bocker init'ì€ ë§¤ìš° ì œí•œì ì¸Â `docker build`Â êµ¬í˜„ì„ ì œê³µí•©ë‹ˆë‹¤.

**ê¸°ëŠ¥ì„ ë§¤ìš° ì œí•œì ìœ¼ë¡œ êµ¬í˜„ë˜ì–´ìˆìŠµë‹ˆë‹¤: ì•„ì§ êµ¬í˜„ë˜ì§€ ì•ŠìŒ**

- ë°ì´í„° ë³¼ë¥¨ ì»¨í…Œì´ë„ˆ
- ë°ì´í„° ë³¼ë¥¨
- í¬íŠ¸ í¬ì›Œë”©
**Bockerì˜ í•µì‹¬ ì»¨í…Œì´ë„ˆ ê¸°ìˆ  ë™ì‘ ì›ë¦¬**

**ì»¨í…Œì´ë„ˆ ê²©ë¦¬ êµ¬í˜„ ë°©ì‹**

BockerëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì˜ ì—¬ëŸ¬ ê²©ë¦¬ ê¸°ìˆ ì„ ì¡°í•©í•´ ê²½ëŸ‰ ì»¨í…Œì´ë„ˆë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤. ê° ê¸°ìˆ ì˜ ì—°ê²° ë°©ì‹ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

> íŒŒì¼ì‹œìŠ¤í…œ ê²©ë¦¬

```plain text
# ì´ë¯¸ì§€ ê¸°ë°˜ ì»¨í…Œì´ë„ˆ ìƒì„±
btrfs subvolume snapshot "$btrfs_path/$1" "$btrfs_path/$uuid" > /dev/null

# íŒŒì¼ì‹œìŠ¤í…œ ê²©ë¦¬
chroot "$btrfs_path/$uuid" /bin/sh -c "..."
```

BockerëŠ”Â **Btrfsì˜ ìŠ¤ëƒ…ìƒ· ê¸°ëŠ¥**ì„ í™œìš©í•´ ì´ë¯¸ì§€ì™€ ì»¨í…Œì´ë„ˆë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. ì´ëŠ” Dockerê°€ ì´ˆê¸°ì— AUFSì™€ ê°™ì€ ê³„ì¸µ íŒŒì¼ì‹œìŠ¤í…œì„ ì‚¬ìš©í•œ ê²ƒê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤. Btrfs ìŠ¤ëƒ…ìƒ·ì€:

1. **Copy-on-Write**: ë³€ê²½ì´ ë°œìƒí•  ë•Œë§Œ ìƒˆ ë°ì´í„° ë¸”ë¡ì„ ìƒì„±í•˜ë¯€ë¡œ ì €ì¥ê³µê°„ì´ íš¨ìœ¨ì ì…ë‹ˆë‹¤
1. **ë¹ ë¥¸ ìƒì„±**: ë©”íƒ€ë°ì´í„°ë§Œ ë³µì‚¬í•˜ë¯€ë¡œ ëŒ€ìš©ëŸ‰ ì´ë¯¸ì§€ë„ ì¦‰ì‹œ ë³µì œë©ë‹ˆë‹¤
1. **ê²©ë¦¬**: ê° ì»¨í…Œì´ë„ˆëŠ” ë…ë¦½ì ì¸ íŒŒì¼ì‹œìŠ¤í…œ ë·°ë¥¼ ê°€ì§‘ë‹ˆë‹¤
`chroot`ëŠ” í”„ë¡œì„¸ìŠ¤ì˜ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ë³€ê²½í•´ ì»¨í…Œì´ë„ˆê°€ í˜¸ìŠ¤íŠ¸ íŒŒì¼ì‹œìŠ¤í…œì— ì ‘ê·¼í•˜ì§€ ëª»í•˜ê²Œ í•©ë‹ˆë‹¤.

> ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬

```plain text
# ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
ip netns add netns_"$uuid"

# ê°€ìƒ ì´ë”ë„· ì¸í„°í˜ì´ìŠ¤ ìƒì„± ë° ì—°ê²°
ip link add dev veth0_"$uuid" type veth peer name veth1_"$uuid"
ip link set veth1_"$uuid" netns netns_"$uuid"

# ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬ ë‚´ì—ì„œ ëª…ë ¹ ì‹¤í–‰
ip netns exec netns_"$uuid" ... ëª…ë ¹ì–´ ì‹¤í–‰ ...
```

ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬ëŠ”Â **ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤**ì™€Â **ê°€ìƒ ì´ë”ë„·(veth) ìŒ**ì„ ì´ìš©í•©ë‹ˆë‹¤:

1. ê° ì»¨í…Œì´ë„ˆëŠ” ì „ìš© ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê°€ì§‘ë‹ˆë‹¤
1. veth ì¸í„°í˜ì´ìŠ¤ ìŒì€ ì»¨í…Œì´ë„ˆì™€ í˜¸ìŠ¤íŠ¸ ì‚¬ì´ì˜ í†µì‹  í„°ë„ ì—­í• ì„ í•©ë‹ˆë‹¤
1. í˜¸ìŠ¤íŠ¸ì˜Â `bridge0`Â ë¸Œë¦¿ì§€ëŠ” ëª¨ë“  ì»¨í…Œì´ë„ˆë¥¼ ì—°ê²°í•˜ëŠ” ê°€ìƒ ìŠ¤ìœ„ì¹˜ì²˜ëŸ¼ ì‘ë™í•©ë‹ˆë‹¤
1. ê° ì»¨í…Œì´ë„ˆëŠ”Â `10.0.0.x`Â í˜•íƒœì˜ ë‚´ë¶€ IPë¥¼ í• ë‹¹ë°›ìŠµë‹ˆë‹¤
ì´ êµ¬ì„±ì€ Dockerì˜ ê¸°ë³¸Â `bridge`Â ë„¤íŠ¸ì›Œí¬ ëª¨ë“œì™€ ë§¤ìš° ìœ ì‚¬í•©ë‹ˆë‹¤.

> í”„ë¡œì„¸ìŠ¤ ê²©ë¦¬

```plain text
# ì—¬ëŸ¬ ê²©ë¦¬ ê¸°ìˆ  ì¡°í•©í•˜ì—¬ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
unshare -fmuip --mount-proc \
    chroot "$btrfs_path/$uuid" \
    /bin/sh -c "..."
```

`unshare`Â ëª…ë ¹ì€ í”„ë¡œì„¸ìŠ¤ë¥¼ ì—¬ëŸ¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œë¶€í„° ê²©ë¦¬í•©ë‹ˆë‹¤:

- `f`: ìƒˆ fork ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (PID ë¶„ë¦¬)
- `m`: ìƒˆ ë§ˆìš´íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (ë§ˆìš´íŠ¸ ì§€ì  ë¶„ë¦¬)
- `u`: ìƒˆ UTS ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (í˜¸ìŠ¤íŠ¸ëª… ë¶„ë¦¬)
- `i`: ìƒˆ IPC ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (IPC ê°ì²´ ë¶„ë¦¬)
- `p`: ìƒˆ PID ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (í”„ë¡œì„¸ìŠ¤ ID ë¶„ë¦¬)
- `-mount-proc`: ìƒˆ /proc ë§ˆìš´íŠ¸ (í”„ë¡œì„¸ìŠ¤ ì •ë³´ ë¶„ë¦¬)
ì´ëŸ° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¡°í•©ìœ¼ë¡œ ì»¨í…Œì´ë„ˆ í”„ë¡œì„¸ìŠ¤ëŠ” í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œì˜ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ë³¼ ìˆ˜ ì—†ê³ , ìì‹ ì´ ì‹œìŠ¤í…œì˜ ìœ ì¼í•œ í”„ë¡œì„¸ìŠ¤ì¸ ê²ƒì²˜ëŸ¼ ì‘ë™í•©ë‹ˆë‹¤.

> ìì› ì œí•œ

```plain text
# cgroup ì„¤ì •
cgcreate -g "$cgroups:/$uuid"
cgset -r cpu.shares="$BOCKER_CPU_SHARE" "$uuid"
cgset -r memory.limit_in_bytes="$((BOCKER_MEM_LIMIT * 1000000))" "$uuid"

# cgroup ë‚´ì—ì„œ ì‹¤í–‰
cgexec -g "$cgroups:$uuid" ëª…ë ¹ì–´
```

- *cgroups(ì»¨íŠ¸ë¡¤ ê·¸ë£¹)**ì€ ì»¨í…Œì´ë„ˆì˜ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ì„ ì œí•œí•©ë‹ˆë‹¤:
1. CPU í• ë‹¹ëŸ‰ì€Â `cpu.shares`ë¡œ ì œì–´ë©ë‹ˆë‹¤ (ê¸°ë³¸ê°’: 512)
1. ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì€Â `memory.limit_in_bytes`ë¡œ ì œí•œë©ë‹ˆë‹¤ (ê¸°ë³¸ê°’: 512MB)
1. ì‚¬ìš©ìëŠ” í™˜ê²½ë³€ìˆ˜(`BOCKER_CPU_SHARE`,Â `BOCKER_MEM_LIMIT`)ë¡œ ì´ ê°’ì„ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
**ì»¨í…Œì´ë„ˆ ë¼ì´í”„ì‚¬ì´í´ ê´€ë¦¬**

> ì´ë¯¸ì§€ â†’ ì»¨í…Œì´ë„ˆ ì „í™˜

```plain text
# ì´ë¯¸ì§€ ì„œë¸Œë³¼ë¥¨ì„ ì»¨í…Œì´ë„ˆë¡œ ë³€í™˜
btrfs subvolume snapshot "$btrfs_path/$1" "$btrfs_path/$uuid" > /dev/null
echo "$cmd" > "$btrfs_path/$uuid/$uuid.cmd"  # ëª…ë ¹ì–´ ê¸°ë¡
```

ì»¨í…Œì´ë„ˆëŠ” ì´ë¯¸ì§€ì˜ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ìƒì„±ë˜ì–´ ì´ë¯¸ì§€ë¥¼ ë³€ê²½í•˜ì§€ ì•Šìœ¼ë©´ì„œ ë…ë¦½ì ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì ‘ê·¼ë²•ì€ Dockerì˜ ì´ë¯¸ì§€ ë ˆì´ì–´ ì‹œìŠ¤í…œê³¼ ì»¨í…Œì´ë„ˆ ë ˆì´ì–´ ê°œë…ê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤.

> ì»¨í…Œì´ë„ˆ â†’ ì´ë¯¸ì§€ ì „í™˜ (commit)

```plain text
# ì»¨í…Œì´ë„ˆë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
bocker_rm "$2" && btrfs subvolume snapshot "$btrfs_path/$1" "$btrfs_path/$2" > /dev/null
```

`bocker_commit`ì€ ì»¨í…Œì´ë„ˆì˜ í˜„ì¬ ìƒíƒœë¥¼ ìƒˆ ì´ë¯¸ì§€ë¡œ ì €ì¥í•©ë‹ˆë‹¤. ì´ëŠ” ë³€ê²½ì‚¬í•­ì„ ì˜êµ¬ì ìœ¼ë¡œ ë³´ì¡´í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ, Dockerì˜Â `docker commit`Â ëª…ë ¹ê³¼ ë™ì¼í•œ ëª©ì ì„ ê°€ì§‘ë‹ˆë‹¤.

> ì»¨í…Œì´ë„ˆ ë‚´ ëª…ë ¹ ì‹¤í–‰ (exec)

```plain text
# ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ PID ì°¾ê¸°
cid="$(ps o ppid,pid | grep "^$(ps o pid,cmd | grep -E "^\ *[0-9]+ unshare.*$1" | awk '{print $1}')" | awk '{print $2}')"

# í•´ë‹¹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì§„ì…í•˜ì—¬ ëª…ë ¹ ì‹¤í–‰
nsenter -t "$cid" -m -u -i -n -p chroot "$btrfs_path/$1" "${@:2}"
```

`nsenter`ëŠ” ê¸°ì¡´ ì»¨í…Œì´ë„ˆì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì§„ì…í•˜ì—¬ ì¶”ê°€ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤. ì´ ë°©ì‹ì€:

1. ë¨¼ì €Â `ps`Â ëª…ë ¹ìœ¼ë¡œ ì»¨í…Œì´ë„ˆì˜ ë©”ì¸ í”„ë¡œì„¸ìŠ¤ PIDë¥¼ ì°¾ìŠµë‹ˆë‹¤
1. í•´ë‹¹ PIDì˜ ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤(ë§ˆìš´íŠ¸, UTS, IPC, ë„¤íŠ¸ì›Œí¬, PID)ì— ì§„ì…í•©ë‹ˆë‹¤
1. `chroot`ë¡œ ì»¨í…Œì´ë„ˆ íŒŒì¼ì‹œìŠ¤í…œì—ì„œ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤
ì´ëŠ” Dockerì˜Â `docker exec`Â ëª…ë ¹ê³¼ ë™ì¼í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.

**ê·¸ ì™¸ êµ¬í˜„**

> ì¬ê·€ì  UUID ì¶©ëŒ í•´ê²°

```plain text
[[ "$(bocker_check "$uuid")" == 0 ]] && echo "UUID conflict, retrying..." && bocker_run "$@" && return
```

UUID ì¶©ëŒì´ ë°œìƒí•˜ë©´(ë§¤ìš° ë“œë¬¸ ê²½ìš°), í•¨ìˆ˜ëŠ” ì¬ê·€ì ìœ¼ë¡œ ìì‹ ì„ í˜¸ì¶œí•˜ì—¬ ìƒˆ UUIDë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì´ëŠ” ê°„ê²°í•˜ì§€ë§Œ ê¹Šì€ ì¬ê·€ê°€ ë°œìƒí•  ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.

> íŒŒì´í”„ë¼ì¸ê³¼ ëª…ë ¹ ì²´ì¸

```plain text
# ë³µì¡í•œ íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ Docker Hub API í† í° ì¶”ì¶œ
token="$(curl -sL -o /dev/null -D- -H 'X-Docker-Token: true' "https://index.docker.io/v1/repositories/$1/images" | tr -d '\r' | awk -F ': *' '$1 == "X-Docker-Token" { print $2 }')"
```

BockerëŠ” ë³µì¡í•œ ë™ì‘ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ ì—¬ëŸ¬ Unix ë„êµ¬ë¥¼ íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ ì—°ê²°í•©ë‹ˆë‹¤. ì´ëŠ” ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì˜ì¡´í•˜ì§€ ì•Šê³  ê¸°ë³¸ ì‹œìŠ¤í…œ ë„êµ¬ë§Œìœ¼ë¡œ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ëŠ” ìœ ë‹‰ìŠ¤ ì² í•™ì„ ë”°ë¦…ë‹ˆë‹¤.

**ê° í•¨ìˆ˜ ì„¤ëª…**

**ì´ˆê¸° ì„¤ì •ê³¼ ê¸°ë³¸ êµ¬ì¡°**

```plain text
#!/usr/bin/env bash
set -o errexit -o nounset -o pipefail; shopt -s nullglob
btrfs_path='/var/bocker' && cgroups='cpu,cpuacct,memory';
```

