{{ define "main" }}
<div class="single-container">
  <article class="post-content">
    <header class="post-header">
      <h1 class="post-title">{{ .Title }}</h1>
      <div class="post-meta">
        <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "January 2, 2006" }}</time>
        {{ if .Params.tags }}
          <div class="post-tags">
            {{ range .Params.tags }}
              <span class="tag">#{{ . }}</span>
            {{ end }}
          </div>
        {{ end }}
      </div>
    </header>

    <!-- TOC 토글 버튼 (좁은 화면에서만 보임) -->
    <button class="toc-toggle" id="tocToggle" aria-label="목차 토글">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="8" y1="6" x2="21" y2="6"></line>
        <line x1="8" y1="12" x2="21" y2="12"></line>
        <line x1="8" y1="18" x2="21" y2="18"></line>
        <line x1="3" y1="6" x2="3.01" y2="6"></line>
        <line x1="3" y1="12" x2="3.01" y2="12"></line>
        <line x1="3" y1="18" x2="3.01" y2="18"></line>
      </svg>
    </button>

    <!-- TOC (목차) -->
    {{ if .TableOfContents }}
      <div class="toc-container" id="toc">
        <div class="toc-header">
          <div class="toc-title">목차</div>
          <button class="toc-close" id="tocClose" aria-label="목차 닫기">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="toc-content">
          {{ .TableOfContents }}
        </div>
      </div>

      <!-- TOC 오버레이 (모바일에서 배경 클릭 시 닫기) -->
      <div class="toc-overlay" id="tocOverlay"></div>
    {{ end }}

    <div class="content">
      {{ .Content }}
    </div>
  </article>
</div>

<script>
// 🎯 스마트 TOC + 토글 스크립트
document.addEventListener('DOMContentLoaded', function() {
  const toc = document.getElementById('toc');
  const tocToggle = document.getElementById('tocToggle');
  const tocClose = document.getElementById('tocClose');
  const tocOverlay = document.getElementById('tocOverlay');
  const tocLinks = document.querySelectorAll('#toc a');
  const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
  
  if (!toc || tocLinks.length === 0 || headings.length === 0) return;

  // TOC 토글 기능
  function toggleToc() {
    toc.classList.toggle('active');
    tocOverlay.classList.toggle('active');
    document.body.classList.toggle('toc-open');
  }

  function closeToc() {
    toc.classList.remove('active');
    tocOverlay.classList.remove('active');
    document.body.classList.remove('toc-open');
  }

  // 이벤트 리스너
  if (tocToggle) tocToggle.addEventListener('click', toggleToc);
  if (tocClose) tocClose.addEventListener('click', closeToc);
  if (tocOverlay) tocOverlay.addEventListener('click', closeToc);

  // ESC 키로 TOC 닫기
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && toc.classList.contains('active')) {
      closeToc();
    }
  });

  // 현재 활성 헤딩 추적
  function updateActiveToc() {
    let current = '';
    const scrollY = window.scrollY;
    
    headings.forEach(heading => {
      const rect = heading.getBoundingClientRect();
      if (rect.top <= 100) {
        current = heading.id;
      }
    });

    // 모든 TOC 링크에서 active 클래스 제거
    tocLinks.forEach(link => {
      link.classList.remove('active');
    });

    // 현재 헤딩에 해당하는 TOC 링크 활성화
    if (current) {
      const activeLink = document.querySelector(`#toc a[href="#${current}"]`);
      if (activeLink) {
        activeLink.classList.add('active');
      }
    }
  }

  // 스크롤 이벤트 리스너 (성능 최적화)
  let ticking = false;
  window.addEventListener('scroll', function() {
    if (!ticking) {
      requestAnimationFrame(updateActiveToc);
      ticking = true;
      setTimeout(() => { ticking = false; }, 15);
    }
  });

  // 초기 실행
  updateActiveToc();

  // TOC 링크 클릭 시 부드러운 스크롤 + 모바일에서 TOC 닫기
  tocLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('href').substring(1);
      const targetElement = document.getElementById(targetId);
      
      if (targetElement) {
        const offsetTop = targetElement.offsetTop - 80;
        window.scrollTo({
          top: offsetTop,
          behavior: 'smooth'
        });

        // 모바일에서 TOC 자동 닫기
        if (window.innerWidth <= 1400) {
          setTimeout(closeToc, 300);
        }
      }
    });
  });

  // 화면 크기 변경 시 TOC 상태 초기화
  window.addEventListener('resize', function() {
    if (window.innerWidth > 1400) {
      closeToc();
    }
  });
});
</script>

<style>
.single-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem 1.5rem;
  position: relative;
}

.post-content {
  max-width: 800px;
  margin: 0 auto;
}

.post-header {
  text-align: center;
  margin-bottom: 3rem;
  padding-bottom: 2rem;
  border-bottom: 1px solid var(--border-color);
}

.post-title {
  font-size: 2.5rem;
  font-weight: 700;
  margin: 0 0 1rem 0;
  line-height: 1.2;
}

.post-meta {
  color: var(--text-muted);
  font-size: 0.95rem;
}

.post-tags {
  margin-top: 0.5rem;
}

.tag {
  display: inline-block;
  background: var(--accent);
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.8rem;
  margin: 0.2rem;
}

/* 🎯 TOC 토글 버튼 (좁은 화면에서만) */
.toc-toggle {
  display: none;
  position: fixed;
  top: 50%;
  right: 1rem;
  transform: translateY(-50%);
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  cursor: pointer;
  z-index: 200;
  transition: all 0.3s ease;
}

.toc-toggle:hover {
  transform: translateY(-50%) scale(1.1);
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

.toc-toggle svg {
  margin: 0;
}

/* 🎯 TOC 컨테이너 */
.toc-container {
  position: fixed;
  right: 2rem;
  top: 50%;
  transform: translateY(-50%);
  width: 280px;
  background: var(--bg-color);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 0;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  z-index: 150;
  max-height: 70vh;
  overflow: hidden;
  transition: all 0.3s ease;
}

.toc-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--border-color);
  background: var(--code-bg);
}

.toc-title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-color);
  margin: 0;
}

.toc-close {
  display: none;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.toc-close:hover {
  color: var(--text-color);
  background: var(--border-color);
}

.toc-content {
  padding: 1rem;
  overflow-y: auto;
  max-height: calc(70vh - 60px);
}

.toc-content ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.toc-content li {
  margin: 0.25rem 0;
}

.toc-content a {
  display: block;
  padding: 0.5rem 0.75rem;
  color: var(--text-muted);
  text-decoration: none;
  font-size: 0.9rem;
  border-radius: 6px;
  transition: all 0.2s ease;
  border-left: 3px solid transparent;
  line-height: 1.4;
}

.toc-content a:hover {
  color: var(--accent);
  background: var(--code-bg);
}

.toc-content a.active {
  color: var(--accent);
  background: var(--code-bg);
  border-left-color: var(--accent);
  font-weight: 500;
}

/* 중첩 레벨 들여쓰기 */
.toc-content ul ul a {
  padding-left: 1.5rem;
  font-size: 0.85rem;
}

.toc-content ul ul ul a {
  padding-left: 2.5rem;
  font-size: 0.8rem;
}

/* TOC 오버레이 */
.toc-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.3);
  z-index: 140;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.content {
  font-size: 1.1rem;
  line-height: 1.7;
  color: var(--text-color);
}

.content h1, .content h2, .content h3, .content h4, .content h5, .content h6 {
  margin-top: 2rem;
  margin-bottom: 1rem;
  scroll-margin-top: 100px;
}

/* 🎯 반응형 TOC (좁은 화면 대응) */
@media (max-width: 1400px) {
  .toc-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .toc-container {
    position: fixed;
    right: -300px; /* 초기에는 숨김 */
    top: 0;
    transform: none;
    width: 300px;
    height: 100vh;
    max-height: 100vh;
    border-radius: 0;
    border-right: none;
    transition: right 0.3s ease;
  }

  .toc-container.active {
    right: 0; /* 활성화 시 나타남 */
  }

  .toc-close {
    display: block;
  }

  .toc-overlay.active {
    display: block;
    opacity: 1;
  }

  .toc-content {
    max-height: calc(100vh - 60px);
  }

  /* 스크롤 방지 */
  body.toc-open {
    overflow: hidden;
  }
}

@media (max-width: 768px) {
  .single-container {
    padding: 1.5rem 1rem;
  }
  
  .post-title {
    font-size: 2rem;
  }
  
  .toc-container {
    width: 280px;
  }
  
  .toc-toggle {
    width: 44px;
    height: 44px;
    right: 0.75rem;
  }
  
  .content {
    font-size: 1rem;
  }
}

@media (max-width: 480px) {
  .toc-container {
    width: 100vw;
    right: -100vw;
  }
  
  .toc-container.active {
    right: 0;
  }
}

/* 다크모드 지원 */
@media (prefers-color-scheme: dark) {
  .toc-container {
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  }
  
  .toc-toggle {
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
  }
  
  .toc-overlay {
    background: rgba(0,0,0,0.5);
  }
}
</style>
{{ end }}
