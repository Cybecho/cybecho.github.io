<!-- Code Copy Enhancement -->
<style>
/* 코드블록 기본 스타일 개선 */
.highlight {
  position: relative;
  margin: 1.5rem 0;
  border-radius: 8px;
  overflow: hidden;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
}

.highlight pre {
  margin: 0;
  padding: 1rem;
  overflow-x: auto;
  background: #f8fafc;
  line-height: 1.5;
  font-size: 0.9rem;
  height: fit-content;
  max-height: 600px;
  color: #1e293b;
}

.highlight code {
  background: transparent;
  padding: 0;
  border-radius: 0;
  font-family: 'Fira Code', 'SF Mono', Consolas, 'Liberation Mono', Menlo, monospace;
  font-size: 0.9rem;
  line-height: 1.5;
  color: #1e293b;
}

/* 코드 복사 버튼 */
.code-copy-btn {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid #e2e8f0;
  color: #475569;
  padding: 0.5rem;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: inherit;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  z-index: 10;
  opacity: 0.8;
  backdrop-filter: blur(4px);
  width: 32px;
  height: 32px;
}

.code-copy-btn:hover {
  background: #3b82f6;
  color: white;
  border-color: #3b82f6;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  opacity: 1;
}

.code-copy-btn.copied {
  background: #10b981 !important;
  color: white !important;
  border-color: #10b981 !important;
  opacity: 1;
}

.code-copy-btn svg {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

/* 일반 pre 태그 스타일링 */
pre:not(.highlight pre) {
  position: relative;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 1rem;
  overflow-x: auto;
  margin: 1.5rem 0;
  font-family: 'Fira Code', 'SF Mono', Consolas, 'Liberation Mono', Menlo, monospace;
  font-size: 0.9rem;
  line-height: 1.5;
  color: #1e293b;
}

/* 인라인 코드 개선 */
code:not(.highlight code):not(pre code) {
  background: #f1f5f9;
  color: #e11d48;
  padding: 0.2em 0.4em;
  border-radius: 3px;
  font-size: 0.85em;
  font-family: 'Fira Code', 'SF Mono', Consolas, monospace;
  border: 1px solid #e2e8f0;
}

/* 반응형 개선 */
@media (max-width: 640px) {
  .highlight pre, pre:not(.highlight pre) {
    font-size: 0.8rem;
    padding: 0.75rem;
  }
  
  .code-copy-btn {
    width: 28px;
    height: 28px;
    top: 0.5rem;
    right: 0.5rem;
  }
  
  .code-copy-btn svg {
    width: 14px;
    height: 14px;
  }
}
</style>

<script>
class CodeCopyEnhancer {
  constructor() {
    this.copyIcon = `<svg fill="currentColor" viewBox="0 0 16 16">
      <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
      <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
    </svg>`;
    
    this.checkIcon = `<svg fill="currentColor" viewBox="0 0 16 16">
      <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
    </svg>`;
    
    this.init();
  }

  init() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => this.enhanceAllCodeBlocks());
    } else {
      this.enhanceAllCodeBlocks();
    }
    
    // 동적으로 추가되는 코드블록 감지
    this.observeContentChanges();
  }

  observeContentChanges() {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach(mutation => {
        if (mutation.type === 'childList') {
          mutation.addedNodes.forEach(node => {
            if (node.nodeType === Node.ELEMENT_NODE) {
              // 새로 추가된 코드블록들 처리
              const newHighlights = node.querySelectorAll ? node.querySelectorAll('.highlight') : [];
              const newPres = node.querySelectorAll ? node.querySelectorAll('pre:not(.highlight pre)') : [];
              
              newHighlights.forEach(block => this.addCopyButton(block));
              newPres.forEach(pre => this.addCopyButton(pre));
              
              // 노드 자체가 코드블록인 경우
              if (node.matches && (node.matches('.highlight') || node.matches('pre:not(.highlight pre)'))) {
                this.addCopyButton(node);
              }
            }
          });
        }
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  }

  enhanceAllCodeBlocks() {
    // .highlight 코드블록들
    const highlightBlocks = document.querySelectorAll('.highlight');
    highlightBlocks.forEach(block => this.addCopyButton(block));
    
    // 일반 pre 태그들 (.highlight 내부가 아닌 것만)
    const preBlocks = document.querySelectorAll('pre:not(.highlight pre)');
    preBlocks.forEach(pre => this.addCopyButton(pre));
  }

  addCopyButton(container) {
    // 이미 복사 버튼이 있으면 건너뛰기
    if (container.querySelector('.code-copy-btn')) {
      return;
    }

    // 코드 내용 추출
    let codeContent = '';
    const codeElement = container.querySelector('code');
    
    if (codeElement) {
      codeContent = codeElement.textContent || codeElement.innerText || '';
    } else if (container.tagName === 'PRE') {
      codeContent = container.textContent || container.innerText || '';
    }
    
    if (!codeContent.trim()) {
      return; // 빈 코드블록은 건너뛰기
    }

    // 복사 버튼 생성
    const copyBtn = document.createElement('button');
    copyBtn.className = 'code-copy-btn';
    copyBtn.innerHTML = this.copyIcon;
    copyBtn.title = '코드 복사';
    copyBtn.setAttribute('aria-label', '코드 복사');
    
    // 클릭 이벤트
    copyBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      this.copyToClipboard(copyBtn, codeContent);
    });

    // 컨테이너를 relative로 설정하고 버튼 추가
    container.style.position = 'relative';
    container.appendChild(copyBtn);
  }

  async copyToClipboard(button, text) {
    try {
      // 클립보드 API 사용
      await navigator.clipboard.writeText(text);
      this.showCopySuccess(button);
    } catch (err) {
      console.warn('클립보드 복사 실패, 폴백 방법 사용:', err);
      // 폴백: execCommand 사용
      this.fallbackCopy(text);
      this.showCopySuccess(button);
    }
  }

  fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-9999px';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    
    textArea.focus();
    textArea.select();
    
    try {
      document.execCommand('copy');
    } catch (err) {
      console.error('폴백 복사도 실패:', err);
    }
    
    document.body.removeChild(textArea);
  }

  showCopySuccess(button) {
    const originalHTML = button.innerHTML;
    button.innerHTML = this.checkIcon;
    button.classList.add('copied');
    
    // 1.5초 후 원래 상태로 복원
    setTimeout(() => {
      button.innerHTML = originalHTML;
      button.classList.remove('copied');
    }, 1500);
  }
}

// 전역으로 초기화
window.codeCopyEnhancer = new CodeCopyEnhancer();
</script>