<!-- Search Modal - LLVM Style -->
<div id="search-modal" class="search-modal" style="display: none;">
  <div class="search-modal-overlay" id="search-overlay"></div>
  <div class="www_sidebar">
    <b>Search</b>
    <br>
    <form action="https://www.google.com/search" method="get">
      <div>
        <input type="hidden" name="sitesearch" value="{{ .Site.BaseURL }}">
        <input type="text" name="q" size="25" id="search-input" placeholder="Search this site...">
        <br>
        <input type="submit" value="Search!">
      </div>
    </form>
    <br>
    <p style="font-size:smaller">Or use Ctrl+K for local search</p>
  </div>
</div>

<style>
/* Search Modal - LLVM Style */
.search-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  display: none;
}

.search-modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
}

.www_sidebar form {
  text-align: center;
}

.www_sidebar input[type="text"] {
  font-family: "Georgia", "Palatino", "Times", "Roman", serif;
  font-size: 12pt;
  padding: 2px 4px;
  border: 1px solid #000000;
  background: #FFFFFF;
  color: #000000;
}

.www_sidebar input[type="submit"] {
  font-family: "Georgia", "Palatino", "Times", "Roman", serif;
  font-size: 12pt;
  padding: 2px 8px;
  border: 1px solid #000000;
  background: #FFFFFF;
  color: #000000;
  cursor: pointer;
}

.www_sidebar input[type="submit"]:hover {
  background: #E0E0E0;
}

/* Position the search box */
.search-modal .www_sidebar {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 300px;
  max-width: 90%;
}

@media (max-width: 768px) {
  .search-modal .www_sidebar {
    width: 85%;
  }
}
</style>

<script>
// Local Search with Fuse.js
let searchIndex = [];
let fuse;

async function initLocalSearch() {
  try {
    const response = await fetch('/index.json');
    searchIndex = await response.json();

    const fuseOptions = {
      keys: [
        { name: 'title', weight: 0.4 },
        { name: 'summary', weight: 0.2 },
        { name: 'content', weight: 0.2 },
        { name: 'tags', weight: 0.1 },
        { name: 'series', weight: 0.1 }
      ],
      threshold: 0.3,
      includeScore: true,
      minMatchCharLength: 2,
      shouldSort: true
    };

    fuse = new Fuse(searchIndex, fuseOptions);

    // Setup local search
    setupLocalSearch();

    console.log('Local search initialized with', searchIndex.length, 'posts');
  } catch (error) {
    console.error('Failed to initialize local search:', error);
  }
}

function setupLocalSearch() {
  const searchModal = document.getElementById('search-modal');
  const searchOverlay = document.getElementById('search-overlay');
  const searchInput = document.getElementById('search-input');

  if (!searchModal) return;

  // Override form submission for local search
  const form = searchModal.querySelector('form');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const query = searchInput.value.trim();
      if (query && fuse) {
        const results = fuse.search(query);
        if (results.length > 0) {
          // Redirect to first result
          window.location.href = results[0].item.url;
        } else {
          alert('No results found for: ' + query);
        }
      }
    });
  }

  // Close modal functions
  function closeModal() {
    searchModal.style.display = 'none';
    searchInput.value = '';
  }

  searchOverlay.addEventListener('click', closeModal);

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && searchModal.style.display !== 'none') {
      closeModal();
    }
  });
}

// Initialize when DOM is loaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initLocalSearch);
} else {
  initLocalSearch();
}
</script>
