<!-- URL Preview Component -->
<div id="url-preview-styles">
<style>
/* URL Preview Card Styles */
.link-preview-card {
  display: flex;
  border: 1px solid var(--border-color);
  border-radius: 12px;
  overflow: hidden;
  margin: 1.5rem 0;
  background: var(--secondary-bg);
  transition: all 0.2s ease;
  cursor: pointer;
  text-decoration: none;
  color: inherit;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  height: auto;
  min-height: 100px;
}

.link-preview-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  border-color: var(--primary-color);
}

.link-preview-card.loading {
  opacity: 0.7;
  pointer-events: none;
}

.preview-image-container {
  width: 180px;
  height: 90px;
  flex-shrink: 0;
  background: var(--tertiary-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.preview-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center;
}

.preview-image-placeholder {
  color: var(--text-color-secondary);
  font-size: 2.2rem;
}

.preview-content {
  padding: 0.75rem;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  min-width: 0;
  min-height: 88px; /* ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆì™€ ë†’ì´ ë§ì¶¤ */
}

.preview-title {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-color);
  margin: 0 0 0.3rem 0;
  line-height: 1.2;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  overflow: hidden;
  text-overflow: ellipsis;
}

.preview-description {
  font-size: 0.8rem;
  color: var(--text-color-secondary);
  line-height: 1.25;
  margin: 0 0 0.4rem 0;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
}

.preview-footer {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.preview-favicon {
  width: 16px;
  height: 16px;
  object-fit: contain;
  border-radius: 2px;
}

.preview-domain {
  font-size: 0.75rem;
  color: var(--primary-color);
  font-weight: 500;
}

.preview-loading {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem;
  color: var(--text-color-secondary);
  font-size: 0.9rem;
}

.preview-loading-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid var(--border-color);
  border-top: 2px solid var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.preview-error {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem;
  color: var(--text-color-secondary);
  font-size: 0.9rem;
  background: var(--secondary-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  margin: 1rem 0;
}

.preview-error-icon {
  color: #ef4444;
}

/* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
@media (max-width: 640px) {
  .link-preview-card {
    flex-direction: column;
    min-height: auto;
  }
  
  .preview-image-container {
    width: 100%;
    height: 140px;
  }
  
  .preview-content {
    padding: 1rem;
    min-height: auto;
  }
  
  .preview-title {
    font-size: 1rem;
    margin: 0 0 0.5rem 0;
  }
  
  .preview-description {
    font-size: 0.875rem;
    -webkit-line-clamp: 2;
    margin: 0 0 0.75rem 0;
  }
}

/* í™”ì´íŠ¸ëª¨ë“œ ê³ ì • - ë‹¤í¬ëª¨ë“œ ì™„ì „ ì œê±° */

/* ì ‘ê·¼ì„± í–¥ìƒ */
.link-preview-card:focus {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

.link-preview-card[aria-label] {
  position: relative;
}

/* ë§í¬ ì•„ì´ì½˜ */
.preview-external-icon {
  width: 12px;
  height: 12px;
  opacity: 0.6;
  margin-left: auto;
}

/* ğŸ¯ YouTube ì„ë² ë”© í”Œë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
.youtube-embed-container {
  position: relative;
  width: 100%;
  height: 0;
  padding-bottom: 56.25%; /* 16:9 ë¹„ìœ¨ */
  margin: 1.5rem 0;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  background: #000;
}

.youtube-embed-iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
  border-radius: 12px;
}

.youtube-embed-info {
  margin-top: 0.75rem;
  padding: 0.75rem;
  background: var(--secondary-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 0.9rem;
}

.youtube-embed-title {
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 0.5rem;
  line-height: 1.3;
}

.youtube-embed-channel {
  color: var(--text-color-secondary);
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.youtube-embed-channel::before {
  content: "ğŸ¥";
  font-size: 1rem;
}

/* Google Drive Embed Styles */
.google-drive-embed-wrapper {
  margin: 1.5rem 0;
  border-radius: 12px;
  overflow: hidden;
  background: var(--secondary-bg);
  border: 1px solid var(--border-color);
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.google-drive-embed-container {
  position: relative;
  width: 100%;
  height: 0;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
  background: #000;
}

.google-drive-embed-iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
}

.google-drive-embed-info {
  padding: 0.75rem;
  background: var(--secondary-bg);
  border-top: 1px solid var(--border-color);
}

.google-drive-embed-title {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 0.25rem;
}

.google-drive-embed-source {
  font-size: 0.8rem;
  color: var(--text-color-secondary);
  opacity: 0.8;
}

.google-drive-embed-source::before {
  content: "ğŸ“ ";
  margin-right: 0.3rem;
}

.google-drive-embed-fallback {
  display: none;
  padding: 1rem;
  background: var(--secondary-bg);
}

.google-drive-link {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  text-decoration: none;
  color: var(--text-color);
  padding: 0.75rem;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  background: var(--primary-bg);
  transition: all 0.2s ease;
}

.google-drive-link:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border-color: var(--primary-color);
}

.google-drive-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

@media (max-width: 768px) {
  .youtube-embed-container {
    margin: 1rem 0;
    border-radius: 8px;
  }
  
  .youtube-embed-info {
    padding: 0.5rem;
    margin-top: 0.5rem;
  }
  
  .youtube-embed-title {
    font-size: 0.85rem;
  }
  
  .youtube-embed-channel {
    font-size: 0.75rem;
  }

  .google-drive-embed-wrapper {
    margin: 1rem 0;
    border-radius: 8px;
  }

  .google-drive-embed-info {
    padding: 0.5rem;
  }

  .google-drive-embed-title {
    font-size: 0.85rem;
  }

  .google-drive-embed-source {
    font-size: 0.75rem;
  }

  .google-drive-link {
    padding: 0.5rem;
  }
}
</style>
</div>

<script>
class URLPreview {
  constructor() {
    this.cache = new Map();
    this.corsProxies = [
      'https://api.codetabs.com/v1/proxy?quest=',
      'https://corsproxy.io/?',
      'https://cors-anywhere.herokuapp.com/'
    ];
    this.currentProxyIndex = 0;
    this.processedLinks = new Set();
    this.config = window.URLPreviewConfig || {};
    this.debounceTimer = null;
  }

  // ë©”ì¸ ì´ˆê¸°í™” í•¨ìˆ˜
  async init() {
    // Intersection Observer ì„¤ì • (ì§€ì—° ë¡œë”©)
    this.setupIntersectionObserver();
    
    // DOMì´ ë¡œë“œëœ í›„ ì‹¤í–‰
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => this.processAllLinks());
    } else {
      this.processAllLinks();
    }
    
    // ë™ì ìœ¼ë¡œ ì¶”ê°€ë˜ëŠ” ì½˜í…ì¸  ê°ì§€
    this.observeContentChanges();
  }

  // Intersection Observer ì„¤ì •
  setupIntersectionObserver() {
    this.intersectionObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const link = entry.target;
            this.intersectionObserver.unobserve(link);
            this.createPreviewCard(link);
          }
        });
      },
      {
        rootMargin: '100px 0px', // ë·°í¬íŠ¸ 100px ì „ì— ë¯¸ë¦¬ ë¡œë“œ
        threshold: 0.1
      }
    );
  }

  // ëª¨ë“  ë§í¬ ì²˜ë¦¬
  processAllLinks() {
    // ë””ë°”ìš´ìŠ¤ ì ìš©
    if (this.debounceTimer) {
      clearTimeout(this.debounceTimer);
    }
    
    this.debounceTimer = setTimeout(() => {
      const links = document.querySelectorAll('a[href^="http"]:not(.no-preview)');
      
      links.forEach(link => {
        if (!this.processedLinks.has(link.href) && this.shouldProcessLink(link)) {
          this.processedLinks.add(link.href);
          // Intersection Observerë¥¼ ì‚¬ìš©í•œ ì§€ì—° ë¡œë”©
          this.intersectionObserver.observe(link);
        }
      });
    }, this.config.debounceTime || 300);
  }

  // ë§í¬ ì²˜ë¦¬ ì—¬ë¶€ íŒë‹¨
  shouldProcessLink(link) {
    const url = link.href;
    
    // ì™¸ë¶€ ë§í¬ì¸ì§€ í™•ì¸
    if (!this.isExternalLink(url)) {
      return false;
    }
    
    // ì œì™¸ ë„ë©”ì¸ í™•ì¸
    if (this.config.excludeDomains) {
      const domain = new URL(url).hostname;
      if (this.config.excludeDomains.some(excludeDomain => domain.includes(excludeDomain))) {
        return false;
      }
    }
    
    // ì œì™¸ ì„ íƒì í™•ì¸
    if (this.config.excludeSelectors) {
      if (this.config.excludeSelectors.some(selector => link.matches(selector))) {
        return false;
      }
    }
    
    // ì œì™¸ íŒ¨í„´ í™•ì¸ (ìœ íŠœë¸ŒëŠ” ì œì™¸í•˜ì§€ ì•ŠìŒ)
    if (this.config.excludePatterns) {
      if (this.config.excludePatterns.some(pattern => pattern.test(url))) {
        return false;
      }
    }
    
    return true;
  }

  // ìœ íŠœë¸Œ ë§í¬ ê°ì§€
  isYouTubeUrl(url) {
    const patterns = [
      /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
      /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/
    ];
    
    return patterns.some(pattern => pattern.test(url));
  }

  // ìœ íŠœë¸Œ ë¹„ë””ì˜¤ ID ì¶”ì¶œ
  extractYouTubeVideoId(url) {
    const patterns = [
      /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
      /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/
    ];
    
    for (const pattern of patterns) {
      const match = url.match(pattern);
      if (match) return match[1];
    }
    return null;
  }

  // Google Drive ë§í¬ ê°ì§€
  isGoogleDriveUrl(url) {
    const pattern = /https:\/\/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\/view/;
    return pattern.test(url);
  }

  // Google Drive íŒŒì¼ ID ì¶”ì¶œ
  extractGoogleDriveFileId(url) {
    const pattern = /https:\/\/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\/view/;
    const match = url.match(pattern);
    return match ? match[1] : null;
  }

  // ì™¸ë¶€ ë§í¬ íŒë³„
  isExternalLink(url) {
    try {
      const linkDomain = new URL(url).hostname;
      const currentDomain = window.location.hostname;
      return linkDomain !== currentDomain;
    } catch {
      return false;
    }
  }

  // ë™ì  ì½˜í…ì¸  ë³€ê²½ ê°ì§€
  observeContentChanges() {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach(mutation => {
        if (mutation.type === 'childList') {
          mutation.addedNodes.forEach(node => {
            if (node.nodeType === 1) { // Element node
              const newLinks = node.querySelectorAll?.('a[href^="http"]:not(.no-preview)') || [];
              newLinks.forEach(link => {
                if (!this.processedLinks.has(link.href) && this.isExternalLink(link.href)) {
                  this.processedLinks.add(link.href);
                  this.createPreviewCard(link);
                }
              });
            }
          });
        }
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  }

  // í”„ë¦¬ë·° ì¹´ë“œ ìƒì„±
  async createPreviewCard(linkElement) {
    const url = linkElement.href;
    
    // ìœ íŠœë¸Œ ë§í¬ì¸ì§€ í™•ì¸
    if (this.isYouTubeUrl(url)) {
      const youtubeEmbed = await this.createYouTubeEmbed(url);
      linkElement.parentNode.replaceChild(youtubeEmbed, linkElement);
      return;
    }
    
    // Google Drive ë§í¬ì¸ì§€ í™•ì¸
    if (this.isGoogleDriveUrl(url)) {
      const driveEmbed = await this.createGoogleDriveEmbed(url);
      linkElement.parentNode.replaceChild(driveEmbed, linkElement);
      return;
    }
    
    const loadingCard = this.createLoadingCard(url);
    
    // ë§í¬ë¥¼ ë¡œë”© ì¹´ë“œë¡œ êµì²´
    linkElement.parentNode.replaceChild(loadingCard, linkElement);

    try {
      const metadata = await this.fetchUrlMetadata(url);
      const previewCard = this.buildPreviewCard(metadata, url);
      loadingCard.replaceWith(previewCard);
    } catch (error) {
      console.warn('URL preview failed:', error);
      const errorCard = this.createErrorCard(url, error.message);
      loadingCard.replaceWith(errorCard);
    }
  }

  // ìœ íŠœë¸Œ ì„ë² ë”© ìƒì„±
  async createYouTubeEmbed(url) {
    const videoId = this.extractYouTubeVideoId(url);
    if (!videoId) {
      return this.createErrorCard(url, 'ìœ íš¨í•˜ì§€ ì•Šì€ YouTube URLì…ë‹ˆë‹¤');
    }

    const container = document.createElement('div');
    container.className = 'youtube-embed-wrapper';
    
    try {
      // YouTube oEmbed APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹„ë””ì˜¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const oembedUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`;
      const response = await fetch(oembedUrl);
      
      let videoInfo = {};
      if (response.ok) {
        videoInfo = await response.json();
      }

      const embedUrl = `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&showinfo=0`;
      
      container.innerHTML = `
        <div class="youtube-embed-container">
          <iframe 
            class="youtube-embed-iframe"
            src="${embedUrl}"
            title="${videoInfo.title || 'YouTube ë™ì˜ìƒ'}"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
            loading="lazy">
          </iframe>
        </div>
        ${videoInfo.title || videoInfo.author_name ? `
          <div class="youtube-embed-info">
            ${videoInfo.title ? `<div class="youtube-embed-title">${this.escapeHtml(videoInfo.title)}</div>` : ''}
            ${videoInfo.author_name ? `<div class="youtube-embed-channel">${this.escapeHtml(videoInfo.author_name)}</div>` : ''}
          </div>
        ` : ''}
      `;
    } catch (error) {
      console.warn('YouTube embed failed:', error);
      // ê¸°ë³¸ ì„ë² ë”©ìœ¼ë¡œ í´ë°±
      const embedUrl = `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&showinfo=0`;
      container.innerHTML = `
        <div class="youtube-embed-container">
          <iframe 
            class="youtube-embed-iframe"
            src="${embedUrl}"
            title="YouTube ë™ì˜ìƒ"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
            loading="lazy">
          </iframe>
        </div>
      `;
    }

    return container;
  }

  // Google Drive ì„ë² ë”© ìƒì„±
  async createGoogleDriveEmbed(url) {
    const fileId = this.extractGoogleDriveFileId(url);
    if (!fileId) {
      return this.createErrorCard(url, 'ìœ íš¨í•˜ì§€ ì•Šì€ Google Drive URLì…ë‹ˆë‹¤');
    }

    const container = document.createElement('div');
    container.className = 'google-drive-embed-wrapper';

    try {
      // /viewë¥¼ /previewë¡œ ë³€ê²½í•˜ì—¬ ì„ë² ë”© ì‹œë„
      const previewUrl = `https://drive.google.com/file/d/${fileId}/preview`;
      
      container.innerHTML = `
        <div class="google-drive-embed-container">
          <iframe 
            class="google-drive-embed-iframe"
            src="${previewUrl}"
            title="Google Drive ë™ì˜ìƒ"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
            loading="lazy">
          </iframe>
        </div>
        <div class="google-drive-embed-info">
          <div class="google-drive-embed-title">Google Drive ë™ì˜ìƒ</div>
          <div class="google-drive-embed-source">Google Driveì—ì„œ ë³´ê¸°</div>
        </div>
        <div class="google-drive-embed-fallback" style="display: none;">
          <a href="${url}" target="_blank" rel="noopener noreferrer" class="google-drive-link">
            <span class="google-drive-icon">ğŸ“</span>
            <div>
              <div>Google Drive íŒŒì¼</div>
              <div style="font-size: 0.8rem; opacity: 0.7;">ë¸Œë¼ìš°ì €ì—ì„œ ì—´ê¸°</div>
            </div>
          </a>
        </div>
      `;

      // iframe ë¡œë”© ì‹¤íŒ¨ ì‹œ í´ë°± ì²˜ë¦¬
      const iframe = container.querySelector('.google-drive-embed-iframe');
      const embedContainer = container.querySelector('.google-drive-embed-container');
      const embedInfo = container.querySelector('.google-drive-embed-info');
      const fallback = container.querySelector('.google-drive-embed-fallback');

      iframe.addEventListener('error', () => {
        embedContainer.style.display = 'none';
        embedInfo.style.display = 'none';
        fallback.style.display = 'flex';
      });

      // ì¼ì • ì‹œê°„ í›„ ë¡œë”© ì‹¤íŒ¨ë¡œ ê°„ì£¼
      setTimeout(() => {
        if (iframe.contentDocument === null) {
          embedContainer.style.display = 'none';
          embedInfo.style.display = 'none';
          fallback.style.display = 'flex';
        }
      }, 5000);

    } catch (error) {
      console.warn('Google Drive embed failed:', error);
      // ì—ëŸ¬ ì‹œ ì¼ë°˜ ë§í¬ë¡œ í´ë°±
      container.innerHTML = `
        <a href="${url}" target="_blank" rel="noopener noreferrer" class="google-drive-link">
          <span class="google-drive-icon">ğŸ“</span>
          <div>
            <div>Google Drive íŒŒì¼</div>
            <div style="font-size: 0.8rem; opacity: 0.7;">ë¸Œë¼ìš°ì €ì—ì„œ ì—´ê¸°</div>
          </div>
        </a>
      `;
    }

    return container;
  }

  // ë¡œë”© ì¹´ë“œ ìƒì„±
  createLoadingCard(url) {
    const card = document.createElement('div');
    card.className = 'link-preview-card loading';
    card.innerHTML = `
      <div class="preview-loading">
        <div class="preview-loading-spinner"></div>
        <span>ë§í¬ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</span>
      </div>
    `;
    return card;
  }

  // ì—ëŸ¬ ì¹´ë“œ ìƒì„±
  createErrorCard(url, errorMessage) {
    const domain = new URL(url).hostname;
    const card = document.createElement('a');
    card.className = 'preview-error';
    card.href = url;
    card.target = '_blank';
    card.rel = 'noopener noreferrer';
    card.innerHTML = `
      <span class="preview-error-icon">âš ï¸</span>
      <div>
        <div>í”„ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
        <div style="font-size: 0.8rem; opacity: 0.7;">${domain}</div>
      </div>
    `;
    return card;
  }

  // URL ë©”íƒ€ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  async fetchUrlMetadata(url) {
    // ìºì‹œ í™•ì¸
    if (this.cache.has(url)) {
      const cached = this.cache.get(url);
      if (Date.now() - cached.timestamp < (this.config.cache?.maxAge || 3600000)) {
        return cached.data;
      } else {
        this.cache.delete(url);
      }
    }

    const metadata = await this.fetchWithFallback(url);
    
    // ìºì‹œ í¬ê¸° ê´€ë¦¬
    const maxSize = this.config.cache?.maxSize || 100;
    if (this.cache.size >= maxSize) {
      // ê°€ì¥ ì˜¤ë˜ëœ í•­ëª© ì œê±° (LRU)
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    
    // ìºì‹œ ì €ì¥ (íƒ€ì„ìŠ¤íƒ¬í”„ì™€ í•¨ê»˜)
    this.cache.set(url, {
      data: metadata,
      timestamp: Date.now()
    });

    return metadata;
  }

  // í”„ë¡ì‹œ í´ë°±ìœ¼ë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  async fetchWithFallback(url) {
    const timeout = this.config.timeout || 10000;
    
    for (let i = 0; i < this.corsProxies.length; i++) {
      try {
        const proxyIndex = (this.currentProxyIndex + i) % this.corsProxies.length;
        const proxyUrl = this.corsProxies[proxyIndex] + encodeURIComponent(url);
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        const response = await fetch(proxyUrl, {
          method: 'GET',
          headers: {
            'User-Agent': 'Mozilla/5.0 (compatible; URLPreview/1.0)'
          },
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const html = await response.text();
        const metadata = this.extractMetadata(html, url);
        
        // ì„±ê³µí•œ í”„ë¡ì‹œë¥¼ ìš°ì„ ìˆœìœ„ë¡œ ì„¤ì •
        this.currentProxyIndex = proxyIndex;
        return metadata;
      } catch (error) {
        console.warn(`Proxy ${i + 1} failed:`, error.message);
        if (i === this.corsProxies.length - 1) {
          throw new Error('ëª¨ë“  í”„ë¡ì‹œ ì„œë²„ì—ì„œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      }
    }
  }

  // HTMLì—ì„œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
  extractMetadata(html, url) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const urlObj = new URL(url);

    // Open Graph ë©”íƒ€íƒœê·¸ ìš°ì„ 
    const getMetaContent = (property) => {
      const og = doc.querySelector(`meta[property="${property}"]`);
      const twitter = doc.querySelector(`meta[name="twitter:${property.replace('og:', '')}"]`);
      const name = doc.querySelector(`meta[name="${property.replace('og:', '')}"]`);
      
      return og?.content || twitter?.content || name?.content || '';
    };

    // ì œëª© ì¶”ì¶œ
    let title = getMetaContent('og:title') || 
                getMetaContent('twitter:title') || 
                doc.querySelector('title')?.textContent || 
                urlObj.hostname;

    // ì„¤ëª… ì¶”ì¶œ  
    let description = getMetaContent('og:description') || 
                     getMetaContent('description') ||
                     getMetaContent('twitter:description') || '';

    // ì´ë¯¸ì§€ ì¶”ì¶œ
    let image = getMetaContent('og:image') || 
                getMetaContent('twitter:image') || '';

    // ìƒëŒ€ URLì„ ì ˆëŒ€ URLë¡œ ë³€í™˜
    if (image && !image.startsWith('http')) {
      try {
        image = new URL(image, url).href;
      } catch {
        image = '';
      }
    }

    // íŒŒë¹„ì½˜ ì¶”ì¶œ
    let favicon = doc.querySelector('link[rel*="icon"]')?.href || '';
    if (favicon && !favicon.startsWith('http')) {
      try {
        favicon = new URL(favicon, url).href;
      } catch {
        favicon = `${urlObj.protocol}//${urlObj.hostname}/favicon.ico`;
      }
    }

    return {
      title: title.trim().substring(0, 100),
      description: description.trim().substring(0, 200),
      image: image,
      favicon: favicon,
      domain: urlObj.hostname,
      url: url
    };
  }

  // í”„ë¦¬ë·° ì¹´ë“œ ìƒì„±
  buildPreviewCard(metadata, url) {
    const card = document.createElement('a');
    card.className = 'link-preview-card';
    card.href = url;
    card.target = '_blank';
    card.rel = 'noopener noreferrer';
    card.setAttribute('aria-label', `ì™¸ë¶€ ë§í¬: ${metadata.title}`);

    // ë„ë©”ì¸ë³„ ì•„ì´ì½˜ ì„¤ì •
    const domain = metadata.domain;
    const fallbackIcon = this.config.fallbackIcons?.[domain] || this.config.fallbackIcons?.['default'] || 'ğŸ”—';
    
    let imageHTML = '';
    if (metadata.image) {
      imageHTML = `<img class="preview-image" src="${metadata.image}" alt="${metadata.title}" loading="lazy" onerror="this.parentElement.innerHTML='<span class=\\"preview-image-placeholder\\">${fallbackIcon}</span>'">`;
    } else {
      imageHTML = `<span class="preview-image-placeholder">${fallbackIcon}</span>`;
    }

    let faviconHTML = '';
    if (metadata.favicon) {
      faviconHTML = `<img class="preview-favicon" src="${metadata.favicon}" alt="" onerror="this.style.display='none'">`;
    }

    card.innerHTML = `
      <div class="preview-image-container">
        ${imageHTML}
      </div>
      <div class="preview-content">
        <h3 class="preview-title">${this.escapeHtml(metadata.title)}</h3>
        ${metadata.description ? `<p class="preview-description">${this.escapeHtml(metadata.description)}</p>` : ''}
        <div class="preview-footer">
          ${faviconHTML}
          <span class="preview-domain">${metadata.domain}</span>
          <svg class="preview-external-icon" fill="currentColor" viewBox="0 0 20 20">
            <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"></path>
            <path d="M5 5a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2v-2a1 1 0 10-2 0v2H5V7h2a1 1 0 000-2H5z"></path>
          </svg>
        </div>
      </div>
    `;

    return card;
  }

  // HTML ì´ìŠ¤ì¼€ì´í”„
  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
}

// URL í”„ë¦¬ë·° ì´ˆê¸°í™”
const urlPreview = new URLPreview();
urlPreview.init();

// ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (í•„ìš”ì‹œ ì‚¬ìš©)
window.URLPreview = URLPreview;
</script>