{{ define "main" }}
<section class="magic-search-page">
  <h1>Cybecho's Magic Search</h1>
  <p>자연어로 질문하면 블로그 글을 모아 답변을 만들어드립니다.</p>

  <form id="magic-search-form" class="magic-search-form">
    <label for="magic-search-input">질문</label>
    <textarea id="magic-search-input" rows="4" placeholder="예: 라즈베리파이로 NAS 구축할 때 고려할 점은?"></textarea>
    <button type="submit">Ask Magic</button>
  </form>

  <div id="magic-search-status" class="magic-search-status" aria-live="polite"></div>

  <div id="magic-search-answer" class="magic-search-answer" hidden>
    <h2>Magic Answer</h2>
    <div id="magic-search-summary"></div>
    <h3>참고 링크</h3>
    <ul id="magic-search-links"></ul>
  </div>
</section>

<style>
  .magic-search-page {
    font-family: "Times New Roman", "Times", serif;
    color: #000000;
    background: #FFFFFF;
    padding: 24px;
    border: 2px solid #000000;
    max-width: 720px;
    margin: 24px auto;
  }

  .magic-search-page h1,
  .magic-search-page h2,
  .magic-search-page h3 {
    margin-top: 0;
  }

  .magic-search-form {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin: 16px 0;
  }

  .magic-search-form textarea {
    border: 1px solid #000000;
    padding: 6px;
    font-size: 12pt;
    resize: vertical;
  }

  .magic-search-form button {
    border: 2px solid #000000;
    background: #FFFFFF;
    color: #000000;
    font-size: 12pt;
    padding: 6px 12px;
    cursor: pointer;
  }

  .magic-search-form button:hover {
    background: #E0E0E0;
  }

  .magic-search-status {
    margin-top: 12px;
    font-style: italic;
  }

  .magic-search-answer {
    margin-top: 18px;
    border-top: 1px solid #000000;
    padding-top: 12px;
  }
</style>

<script>
  const magicForm = document.getElementById('magic-search-form');
  const magicInput = document.getElementById('magic-search-input');
  const magicStatus = document.getElementById('magic-search-status');
  const magicAnswer = document.getElementById('magic-search-answer');
  const magicSummary = document.getElementById('magic-search-summary');
  const magicLinks = document.getElementById('magic-search-links');

  let magicIndex = [];
  let magicFuse;

  async function ensureMagicIndex() {
    if (magicFuse) return;
    const response = await fetch('/index.json');
    magicIndex = await response.json();
    magicFuse = new Fuse(magicIndex, {
      keys: [
        { name: 'title', weight: 0.4 },
        { name: 'summary', weight: 0.2 },
        { name: 'content', weight: 0.2 },
        { name: 'tags', weight: 0.1 },
        { name: 'series', weight: 0.1 }
      ],
      threshold: 0.35,
      includeScore: true,
      minMatchCharLength: 2
    });
  }

  function buildMagicSummary(results) {
    const snippets = results.map((result, index) => {
      const item = result.item;
      const baseText = item.summary || item.content || '';
      const trimmed = baseText.length > 200 ? baseText.slice(0, 200) + '...' : baseText;
      return `<p><strong>${index + 1}. ${item.title}</strong><br>${trimmed}</p>`;
    });
    return `
      <p>입력한 질문과 관련된 글을 모아 요약했습니다.</p>
      ${snippets.join('')}
    `;
  }

  function renderReferences(results) {
    magicLinks.innerHTML = results.map(result => {
      const item = result.item;
      return `<li><a href="${item.url}">${item.title}</a></li>`;
    }).join('');
  }

  async function handleMagicSubmit(event) {
    event.preventDefault();
    const query = magicInput.value.trim();

    if (!query) {
      magicStatus.textContent = '질문을 입력해주세요.';
      magicAnswer.hidden = true;
      return;
    }

    magicStatus.textContent = 'Magic Search가 글을 모으는 중입니다...';
    await ensureMagicIndex();

    const results = magicFuse.search(query).slice(0, 5);

    if (results.length === 0) {
      magicStatus.textContent = '관련된 글을 찾지 못했습니다.';
      magicAnswer.hidden = true;
      return;
    }

    magicSummary.innerHTML = buildMagicSummary(results);
    renderReferences(results);
    magicAnswer.hidden = false;
    magicStatus.textContent = '완료되었습니다.';
  }

  if (magicForm) {
    magicForm.addEventListener('submit', handleMagicSubmit);
  }
</script>
{{ end }}
