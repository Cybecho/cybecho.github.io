name: Deploy Hugo to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0  # Git info를 위해 전체 히스토리 필요

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      # 기본 콘텐츠 생성
      - name: Create default content
        run: |
          # About 페이지 생성
          mkdir -p content
          cat > content/about.md << 'EOF'
          ---
          title: "소개"
          date: 2024-01-01T00:00:00+09:00
          draft: false
          ---

          # 안녕하세요, Cybecho입니다! 👋

          개발자로서의 삽질과 성장을 기록하는 공간입니다.

          ## 이 블로그는...
          - 🔧 개발 삽질기  
          - 📚 학습 노트
          - 💡 문제 해결 과정
          - 🚀 새로운 기술 탐험

          을 다룹니다.

          ## 연락처
          - **GitHub**: [@Cybecho](https://github.com/Cybecho)
          - **Blog**: [삽질 저장소](https://cybecho.github.io)

          ---
          *"실패는 성공의 어머니, 삽질은 성장의 아버지"* ✨
          EOF

          # Welcome 포스트 생성  
          mkdir -p content/posts/welcome
          cat > content/posts/welcome/index.md << 'EOF'
          ---
          title: "🎉 삽질 저장소 오픈!"
          date: 2024-01-20T00:00:00+09:00
          draft: false
          tags: ["환영", "첫글", "블로그"]
          categories: ["공지"]
          summary: "개발자 Cybecho의 기술 블로그가 드디어 오픈했습니다!"
          ---

          # 삽질 저장소에 오신 것을 환영합니다! 🎉

          안녕하세요! 개발자 **Cybecho**입니다.

          드디어 제 개인 기술 블로그인 **삽질 저장소**가 문을 열었습니다.

          ## 왜 "삽질 저장소"인가요? 🤔

          개발을 하면서 겪는 수많은 시행착오들...
          - ❌ 몇 시간 동안 헤맨 버그들
          - 🔧 삽질 끝에 찾은 해결책들  
          - 📚 새로 배운 기술과 개념들
          - 💡 "아하!" 하는 깨달음의 순간들

          이런 모든 **삽질**들이 결국 성장의 밑거름이 됩니다.

          ## 다룰 주제들 📝

          ### 🖥️ 기술 스택
          - **Frontend**: React, Vue.js, TypeScript
          - **Backend**: Node.js, Python, Java  
          - **DevOps**: Docker, Kubernetes, AWS
          - **Database**: MySQL, PostgreSQL, MongoDB

          ### 📖 콘텐츠 유형
          - **삽질기**: 실패와 성공의 솔직한 기록
          - **학습 노트**: 새로 배운 기술 정리
          - **프로젝트 후기**: 실제 경험담
          - **도구 리뷰**: 유용한 개발 도구들

          ## 블로그 기술 스택 🛠️

          - **CMS**: Notion (글 작성)
          - **Generator**: Hugo + Lightbi Theme
          - **Hosting**: GitHub Pages  
          - **CI/CD**: GitHub Actions
          - **Domain**: cybecho.github.io

          ## 앞으로의 계획 🚀

          - 📅 **정기 포스팅**: 주 1~2회 목표
          - 📚 **시리즈 연재**: 심화 주제들  
          - 🔧 **오픈소스**: 제작 도구 공유
          - 👥 **커뮤니티**: 개발자 네트워킹

          ---

          궁금한 점이나 피드백은 언제든 GitHub을 통해 연락 주세요!

          **Happy Coding!** ✨
          EOF

      # Hugo 빌드
      - name: Build with Hugo
        env:
          HUGO_ENVIRONMENT: production
          HUGO_ENV: production
        run: |
          echo "Building Hugo site..."
          hugo --gc --minify

      # 빌드 결과 확인
      - name: List generated files
        run: |
          echo "=== Generated files ==="
          ls -la public/
          echo "=== Pages created ==="
          find public -name "*.html" | wc -l
          echo "HTML files generated"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
