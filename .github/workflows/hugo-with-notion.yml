name: Hugo with Direct Notion API

on:
  push:
    branches: ["main"]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      # ðŸ”§ Notion ë™ê¸°í™” - ë‹¤ë¥¸ ë„êµ¬ ì‚¬ìš©
      - name: Sync with Notion (Alternative)
        run: |
          echo "ðŸ”„ Trying alternative Notion sync methods..."
          
          # ë°©ë²• 1: notion-blog-kit ì‹œë„
          npm install -g notion-blog-kit || echo "notion-blog-kit install failed"
          
          # ë°©ë²• 2: ìˆ˜ë™ í™•ì¸ì„ ìœ„í•œ curl í…ŒìŠ¤íŠ¸
          echo "ðŸ§ª Testing Notion API connection..."
          curl -X POST https://api.notion.com/v1/databases/${{ secrets.DATABASE_ID }}/query \
            -H 'Authorization: Bearer ${{ secrets.NOTION_SECRET }}' \
            -H 'Notion-Version: 2022-06-28' \
            -H 'Content-Type: application/json' \
            -d '{"filter":{"property":"Status","select":{"equals":"Published"}},"page_size":5}' \
            > notion_test.json || echo "API call failed"
          
          if [ -f notion_test.json ]; then
            echo "ðŸ“Š API Response sample:"
            head -20 notion_test.json
          fi

      # ðŸŽ¯ ì „ë¬¸ Notion â†’ Hugo ë„êµ¬ ì‚¬ìš©
      - name: Install and Use notion-hugo
        run: |
          echo "ðŸš€ Using notion-hugo tool..."
          
          # Python ê¸°ë°˜ ë„êµ¬ ì‹œë„
          pip install notion-client || echo "notion-client install failed"
          
          # Go ê¸°ë°˜ ë„êµ¬ ì„¤ì¹˜ ì‹œë„
          wget -O notion2hugo https://github.com/younho9/notion2hugo/releases/latest/download/notion2hugo-linux-amd64 || echo "notion2hugo download failed"
          chmod +x notion2hugo || echo "chmod failed"
          
          # ì‹¤í–‰ ì‹œë„
          ./notion2hugo \
            --token="${{ secrets.NOTION_SECRET }}" \
            --database-id="${{ secrets.DATABASE_ID }}" \
            --output-dir="content/posts" \
            --filter-prop="Status" \
            --filter-value="Published" || echo "notion2hugo execution failed"

      # ðŸ”§ ëŒ€ì•ˆ: JavaScriptë¡œ ì§ì ‘ êµ¬í˜„
      - name: Custom Notion Sync Script
        run: |
          echo "ðŸ› ï¸ Creating custom sync script..."
          cat > sync_notion.js << 'EOF'
          const { Client } = require('@notionhq/client');
          const fs = require('fs');
          const path = require('path');

          const notion = new Client({
            auth: process.env.NOTION_SECRET,
          });

          async function syncNotionDatabase() {
            try {
              console.log('ðŸ”„ Connecting to Notion...');
              
              const response = await notion.databases.query({
                database_id: process.env.DATABASE_ID,
                filter: {
                  property: 'Status',
                  select: {
                    equals: 'Published'
                  }
                },
                page_size: 10
              });

              console.log(`ðŸ“Š Found ${response.results.length} published posts`);

              if (!fs.existsSync('content/posts')) {
                fs.mkdirSync('content/posts', { recursive: true });
              }

              for (const page of response.results) {
                try {
                  const title = page.properties.Title?.title?.[0]?.plain_text || 'Untitled';
                  const slug = title.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
                  
                  // íŽ˜ì´ì§€ ì½˜í…ì¸  ê°€ì ¸ì˜¤ê¸°
                  const blocks = await notion.blocks.children.list({
                    block_id: page.id,
                  });

                  let content = `---\ntitle: "${title}"\ndate: ${new Date().toISOString()}\ndraft: false\n---\n\n# ${title}\n\n`;
                  
                  // ê°„ë‹¨í•œ ë¸”ë¡ ë³€í™˜
                  for (const block of blocks.results) {
                    if (block.type === 'paragraph' && block.paragraph?.rich_text) {
                      const text = block.paragraph.rich_text.map(t => t.plain_text).join('');
                      content += text + '\n\n';
                    } else if (block.type === 'heading_1' && block.heading_1?.rich_text) {
                      const text = block.heading_1.rich_text.map(t => t.plain_text).join('');
                      content += `# ${text}\n\n`;
                    } else if (block.type === 'heading_2' && block.heading_2?.rich_text) {
                      const text = block.heading_2.rich_text.map(t => t.plain_text).join('');
                      content += `## ${text}\n\n`;
                    }
                  }

                  const postDir = `content/posts/${slug}`;
                  if (!fs.existsSync(postDir)) {
                    fs.mkdirSync(postDir, { recursive: true });
                  }
                  
                  fs.writeFileSync(`${postDir}/index.md`, content);
                  console.log(`âœ… Created post: ${title}`);
                } catch (err) {
                  console.error(`âŒ Error processing page: ${err.message}`);
                }
              }
            } catch (error) {
              console.error('âŒ Notion API Error:', error.message);
              process.exit(0); // ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
            }
          }

          syncNotionDatabase();
          EOF

          # í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ì‹¤í–‰
          npm init -y
          npm install @notionhq/client
          
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          NOTION_SECRET="${{ secrets.NOTION_SECRET }}" DATABASE_ID="${{ secrets.DATABASE_ID }}" node sync_notion.js

      # ë™ê¸°í™” ê²°ê³¼ í™•ì¸
      - name: Check Sync Results
        run: |
          echo "ðŸ“Š Sync Results:"
          echo "=== Posts directory ==="
          find content/posts -name "*.md" -type f | wc -l
          echo "total posts"
          
          echo "=== Sample posts ==="
          find content/posts -name "*.md" -type f | head -3
          
          echo "=== Content preview ==="
          for file in $(find content/posts -name "*.md" -type f | head -2); do
            echo "ðŸ“„ File: $file"
            head -10 "$file"
            echo "---"
          done

      # ê¸°ë³¸ ì½˜í…ì¸  ìƒì„±
      - name: Ensure Default Content
        run: |
          # About íŽ˜ì´ì§€
          if [ ! -f content/about.md ]; then
            mkdir -p content
            cat > content/about.md << 'EOF'
          ---
          title: "ì†Œê°œ"
          date: 2024-01-01T00:00:00+09:00
          draft: false
          ---

          # ì•ˆë…•í•˜ì„¸ìš”, Cybechoìž…ë‹ˆë‹¤! ðŸ‘‹

          ê°œë°œìžë¡œì„œì˜ ì‚½ì§ˆê³¼ ì„±ìž¥ì„ ê¸°ë¡í•˜ëŠ” ê³µê°„ìž…ë‹ˆë‹¤.

          ## Notion ì—°ë™ ìƒíƒœ

          - **ë°ì´í„°ë² ì´ìŠ¤**: [ì‚½ì§ˆ ì €ìž¥ì†Œ](https://notion.so/${{ secrets.DATABASE_ID }})  
          - **ìžë™ ë™ê¸°í™”**: ë§¤ì¼ ìƒˆë²½ 2ì‹œ
          - **ìˆ˜ë™ ë™ê¸°í™”**: GitHub Actionsì—ì„œ "Run workflow"

          ## ì—°ë½ì²˜
          - **GitHub**: [@Cybecho](https://github.com/Cybecho)

          ---
          *Notion APIë¥¼ í†µí•´ Published ìƒíƒœì˜ ê¸€ë“¤ì´ ìžë™ ë™ê¸°í™”ë©ë‹ˆë‹¤* âœ¨
          EOF
          fi

          # ë™ê¸°í™” ìƒíƒœ í¬ìŠ¤íŠ¸
          mkdir -p content/posts/sync-status
          cat > content/posts/sync-status/index.md << 'EOF'
          ---
          title: "ðŸ”„ Notion ë™ê¸°í™” ìƒíƒœ"
          date: 2024-01-20T10:00:00+09:00
          draft: false
          tags: ["Notion", "ë™ê¸°í™”", "ìƒíƒœ"]
          categories: ["ê¸°ìˆ "]
          ---

          # Notion ë™ê¸°í™” ìƒíƒœ ë¦¬í¬íŠ¸

          **ë§ˆì§€ë§‰ ë™ê¸°í™”**: $(date '+%Y-%m-%d %H:%M:%S')

          ## ì„¤ì • ì •ë³´
          - **Database ID**: `${{ secrets.DATABASE_ID }}`
          - **í•„í„°**: Status = "Published"
          - **ë™ê¸°í™” ë°©ì‹**: ì§ì ‘ Notion API í˜¸ì¶œ

          ## ë™ê¸°í™”ëœ ê¸€ ìˆ˜
          $(find content/posts -name "*.md" -type f | wc -l) ê°œì˜ í¬ìŠ¤íŠ¸

          ## ë¬¸ì œ í•´ê²°
          ë§Œì•½ Notion ê¸€ì´ ë™ê¸°í™”ë˜ì§€ ì•ŠëŠ”ë‹¤ë©´:
          1. Notionì—ì„œ Statusë¥¼ "Published"ë¡œ ì„¤ì •í–ˆëŠ”ì§€ í™•ì¸
          2. Integrationì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°ë˜ì–´ ìžˆëŠ”ì§€ í™•ì¸
          3. GitHub Actions ë¡œê·¸ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸

          **ë‹¤ìŒ ìžë™ ë™ê¸°í™”**: ë§¤ì¼ ìƒˆë²½ 2ì‹œ (KST)
          EOF

      # Hugo ë¹Œë“œ
      - name: Build with Hugo
        env:
          HUGO_ENVIRONMENT: production
        run: |
          echo "ðŸ—ï¸ Building Hugo site..."
          hugo --gc --minify

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
