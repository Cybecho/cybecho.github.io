name: Hugo with Direct Notion API

on:
  push:
    branches: ["main"]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      # ğŸ”§ ìˆ˜ì •ëœ Notion ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸ (AI ìš”ì•½ 50ì ì œí•œ + í† ê¸€ ì§€ì›)
      - name: Enhanced Notion Sync Script
        run: |
          echo "ğŸš€ Creating enhanced Notion sync script..."
          cat > sync_notion.js << 'EOF'
          const { Client } = require('@notionhq/client');
          const fs = require('fs');
          const path = require('path');

          const notion = new Client({
            auth: process.env.NOTION_SECRET,
          });

          // YAML ì•ˆì „ ë¬¸ìì—´ ìƒì„± í•¨ìˆ˜
          function createSafeYamlString(str) {
            if (!str) return '""';

            const escaped = str
              .replace(/\\/g, '\\\\')
              .replace(/"/g, '\\"')
              .replace(/\n/g, '\\n')
              .replace(/\r/g, '\\r')
              .replace(/\t/g, '\\t');

            return `"${escaped}"`;
          }

          // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜
          function formatDate(dateString) {
            if (!dateString) return new Date().toISOString();
            const date = new Date(dateString);
            return date.toISOString();
          }

          // ì•ˆì „í•œ ìŠ¬ëŸ¬ê·¸ ìƒì„± í•¨ìˆ˜
          function createSlug(title) {
            return title
              .toLowerCase()
              .replace(/[^a-z0-9ê°€-í£\s]/g, '')
              .replace(/\s+/g, '-')
              .replace(/-+/g, '-')
              .replace(/^-|-$/g, '')
              .substring(0, 100);
          }

          // ë¦¬ì¹˜ í…ìŠ¤íŠ¸ ë³€í™˜ í•¨ìˆ˜
          function convertRichText(richTextArray) {
            if (!richTextArray || !Array.isArray(richTextArray)) return '';

            return richTextArray.map(textObj => {
              let text = textObj.plain_text || '';

              if (textObj.annotations?.bold) text = `**${text}**`;
              if (textObj.annotations?.italic) text = `*${text}*`;
              if (textObj.annotations?.code) text = '`' + text + '`';
              if (textObj.href) text = `[${text}](${textObj.href})`;

              return text;
            }).join('');
          }

          // ë¸”ë¡ ë³€í™˜ í•¨ìˆ˜ (í† ê¸€ ë¸”ë¡ í¬í•¨)
          async function convertBlocks(pageId, depth = 0) {
            try {
              const blocks = await notion.blocks.children.list({
                block_id: pageId,
                page_size: 100
              });

              let content = '';
              const indent = '  '.repeat(depth);

              for (const block of blocks.results) {
                switch (block.type) {
                  case 'paragraph':
                    if (block.paragraph?.rich_text?.length > 0) {
                      content += indent + convertRichText(block.paragraph.rich_text) + '\n\n';
                    }
                    break;

                  case 'heading_1':
                    if (block.heading_1?.rich_text?.length > 0) {
                      content += indent + '# ' + convertRichText(block.heading_1.rich_text) + '\n\n';
                    }
                    break;

                  case 'heading_2':
                    if (block.heading_2?.rich_text?.length > 0) {
                      content += indent + '## ' + convertRichText(block.heading_2.rich_text) + '\n\n';
                    }
                    break;

                  case 'heading_3':
                    if (block.heading_3?.rich_text?.length > 0) {
                      content += indent + '### ' + convertRichText(block.heading_3.rich_text) + '\n\n';
                    }
                    break;

                  case 'bulleted_list_item':
                    if (block.bulleted_list_item?.rich_text?.length > 0) {
                      content += indent + '- ' + convertRichText(block.bulleted_list_item.rich_text) + '\n';
                      
                      // ì¤‘ì²©ëœ ìì‹ ë¸”ë¡ ì²˜ë¦¬
                      if (block.has_children) {
                        const childContent = await convertBlocks(block.id, depth + 1);
                        content += childContent;
                      }
                    }
                    break;

                  case 'numbered_list_item':
                    if (block.numbered_list_item?.rich_text?.length > 0) {
                      content += indent + '1. ' + convertRichText(block.numbered_list_item.rich_text) + '\n';
                      
                      // ì¤‘ì²©ëœ ìì‹ ë¸”ë¡ ì²˜ë¦¬
                      if (block.has_children) {
                        const childContent = await convertBlocks(block.id, depth + 1);
                        content += childContent;
                      }
                    }
                    break;

                  case 'toggle':
                    if (block.toggle?.rich_text?.length > 0) {
                      const toggleTitle = convertRichText(block.toggle.rich_text);
                      content += indent + '<details>\n' + indent + '<summary>' + toggleTitle + '</summary>\n\n';
                      
                      // í† ê¸€ ë‚´ë¶€ì˜ ìì‹ ë¸”ë¡ë“¤ ì²˜ë¦¬
                      if (block.has_children) {
                        const childContent = await convertBlocks(block.id, depth);
                        content += childContent;
                      }
                      
                      content += indent + '</details>\n\n';
                    }
                    break;

                  case 'code':
                    if (block.code?.rich_text?.length > 0) {
                      const language = block.code.language || '';
                      const codeText = convertRichText(block.code.rich_text);
                      content += indent + '```' + language + '\n' + codeText + '\n```\n\n';
                    }
                    break;

                  case 'quote':
                    if (block.quote?.rich_text?.length > 0) {
                      content += indent + '> ' + convertRichText(block.quote.rich_text) + '\n\n';
                    }
                    break;

                  case 'callout':
                    if (block.callout?.rich_text?.length > 0) {
                      const icon = block.callout.icon?.emoji || 'ğŸ“';
                      content += indent + icon + ' **' + convertRichText(block.callout.rich_text) + '**\n\n';
                    }
                    break;

                  case 'divider':
                    content += indent + '---\n\n';
                    break;

                  case 'to_do':
                    if (block.to_do?.rich_text?.length > 0) {
                      const checked = block.to_do.checked ? '[x]' : '[ ]';
                      content += indent + '- ' + checked + ' ' + convertRichText(block.to_do.rich_text) + '\n';
                    }
                    break;
                }

                // API í˜¸ì¶œ ì œí•œ ë°©ì§€ë¥¼ ìœ„í•œ ì§€ì—°
                await new Promise(resolve => setTimeout(resolve, 50));
              }

              return content;
            } catch (error) {
              console.error('âŒ Error converting blocks: ' + error.message);
              return '';
            }
          }

          // ëª¨ë“  í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸° (í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬)
          async function getAllPages() {
            let allPages = [];
            let hasMore = true;
            let nextCursor = undefined;

            while (hasMore) {
              try {
                const response = await notion.databases.query({
                  database_id: process.env.DATABASE_ID,
                  filter: {
                    property: 'Status',
                    select: {
                      equals: 'Published'
                    }
                  },
                  sorts: [
                    {
                      property: 'Date',
                      direction: 'descending'
                    }
                  ],
                  start_cursor: nextCursor,
                  page_size: 100  // ìµœëŒ€ 100ê°œì”©
                });

                allPages = allPages.concat(response.results);
                hasMore = response.has_more;
                nextCursor = response.next_cursor;

                console.log('ğŸ“„ Retrieved ' + response.results.length + ' pages (Total: ' + allPages.length + ')');

                // API ì œí•œ ë°©ì§€
                if (hasMore) {
                  await new Promise(resolve => setTimeout(resolve, 100));
                }

              } catch (error) {
                console.error('âŒ Error fetching pages: ' + error.message);
                break;
              }
            }

            return allPages;
          }

          async function syncNotionDatabase() {
            try {
              console.log('ğŸ”„ Connecting to Notion...');

              const allPages = await getAllPages();
              console.log('ğŸ“Š Found ' + allPages.length + ' published posts');

              if (!fs.existsSync('content/posts')) {
                fs.mkdirSync('content/posts', { recursive: true });
              }

              let successCount = 0;
              let errorCount = 0;

              for (const page of allPages) {
                try {
                  const title = page.properties['ì œëª©']?.title?.[0]?.plain_text || 'Untitled';
                  const dateValue = page.properties['Date']?.date?.start || page.created_time;
                  const tags = page.properties['Tags']?.multi_select?.map(tag => tag.name) || [];
                  const themes = page.properties['Thems']?.multi_select?.map(theme => theme.name) || [];
                  const aiSummary = page.properties['AI ìš”ì•½']?.rich_text?.[0]?.plain_text || '';

                  const slug = createSlug(title);

                  console.log('ğŸ“ Processing: "' + title + '"');

                  const blockContent = await convertBlocks(page.id);

                  let content = '---\n';
                  content += 'title: ' + createSafeYamlString(title) + '\n';
                  content += 'date: ' + formatDate(dateValue) + '\n';
                  content += 'draft: false\n';

                  if (tags.length > 0 || themes.length > 0) {
                    const allTags = [...tags, ...themes].map(tag => createSafeYamlString(tag));
                    content += 'tags: [' + allTags.join(', ') + ']\n';
                  }

                  if (themes.length > 0) {
                    const categories = themes.map(theme => createSafeYamlString(theme));
                    content += 'categories: [' + categories.join(', ') + ']\n';
                  }

                  // AI ìš”ì•½ 50ì ì œí•œ ì²˜ë¦¬
                  if (aiSummary) {
                    const truncatedSummary = aiSummary.length > 50 ? 
                      aiSummary.substring(0, 50) + '...' : aiSummary;
                    content += 'description: ' + createSafeYamlString(truncatedSummary) + '\n';
                  }

                  content += 'notion_id: ' + createSafeYamlString(page.id) + '\n';
                  content += 'notion_url: ' + createSafeYamlString(page.url) + '\n';
                  content += '---\n\n';

                  if (blockContent.trim()) {
                    content += blockContent;
                  } else {
                    content += '# ' + title + '\n\n*ì´ ê¸€ì€ Notionì—ì„œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.*\n\n';
                    content += '[ì›ë³¸ ë³´ê¸°](' + page.url + ')\n';
                  }

                  const postDir = 'content/posts/' + slug;
                  if (!fs.existsSync(postDir)) {
                    fs.mkdirSync(postDir, { recursive: true });
                  }

                  fs.writeFileSync(postDir + '/index.md', content, 'utf8');

                  console.log('âœ… Created: "' + title + '" â†’ ' + slug);
                  successCount++;

                  // API ì œí•œ ë°©ì§€
                  await new Promise(resolve => setTimeout(resolve, 100));

                } catch (err) {
                  console.error('âŒ Error processing page: ' + err.message);
                  errorCount++;
                }
              }

              console.log('\nğŸ“Š ë™ê¸°í™” ì™„ë£Œ:');
              console.log('âœ… ì„±ê³µ: ' + successCount + 'ê°œ');
              console.log('âŒ ì‹¤íŒ¨: ' + errorCount + 'ê°œ');

            } catch (error) {
              console.error('âŒ Notion API Error: ' + error.message);
              process.exit(0);
            }
          }

          syncNotionDatabase();
          EOF

          npm init -y
          npm install @notionhq/client

          NOTION_SECRET="${{ secrets.NOTION_SECRET }}" DATABASE_ID="${{ secrets.DATABASE_ID }}" node sync_notion.js

      - name: Check Sync Results
        run: |
          echo "ğŸ“Š ë™ê¸°í™” ê²°ê³¼:"
          echo "=== ìƒì„±ëœ í¬ìŠ¤íŠ¸ ==="
          find content/posts -name "*.md" -type f | wc -l
          echo "ê°œì˜ í¬ìŠ¤íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          echo "=== í¬ìŠ¤íŠ¸ ëª©ë¡ ==="
          find content/posts -name "index.md" -type f | head -5
          
          echo "=== YAML ê²€ì¦ ==="
          for file in $(find content/posts -name "index.md" -type f | head -3); do
            echo "ğŸ” ê²€ì‚¬ ì¤‘: $file"
            # YAML front matter ì¶”ì¶œ ë° ê²€ì¦
            sed -n '1,/^---$/p' "$file" | head -15
            echo "---"
          done

      - name: Ensure Default Content
        run: |
          # About í˜ì´ì§€
          if [ ! -f content/about.md ]; then
            mkdir -p content
            cat > content/about.md << 'EOF'
          ---
          title: "ì†Œê°œ"
          date: 2024-01-01T00:00:00+09:00
          draft: false
          ShowToc: false
          ShowBreadCrumbs: false
          ---
          
          # ì•ˆë…•í•˜ì„¸ìš”, Cybechoì…ë‹ˆë‹¤! ğŸ‘‹
          
          ê°œë°œìë¡œì„œì˜ ì‚½ì§ˆê³¼ ì„±ì¥ì„ ê¸°ë¡í•˜ëŠ” ê³µê°„ì…ë‹ˆë‹¤.
          
          ## ğŸš€ ì´ ë¸”ë¡œê·¸ëŠ”...
          
          - **Notion ì—°ë™**: í¸ë¦¬í•œ ê¸€ ì‘ì„±ê³¼ ê´€ë¦¬
          - **ìë™ ë°°í¬**: GitHub Actionsë¥¼ í†µí•œ ìë™í™”
          - **ë°˜ì‘í˜•**: ëª¨ë“  ë””ë°”ì´ìŠ¤ì—ì„œ ì™„ë²½í•œ ê²½í—˜
          
          ## ğŸ“Š Notion ì—°ë™ ìƒíƒœ
          
          - **ë°ì´í„°ë² ì´ìŠ¤**: ì‚½ì§ˆ ì €ì¥ì†Œ
          - **ìë™ ë™ê¸°í™”**: ë§¤ì¼ ìƒˆë²½ 2ì‹œ (KST)
          - **ìˆ˜ë™ ë™ê¸°í™”**: GitHub Actionsì—ì„œ "Run workflow"
          
          ## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ
          
          - **ì •ì  ì‚¬ì´íŠ¸ ìƒì„±ê¸°**: Hugo
          - **í…Œë§ˆ**: Hugo Blog Awesome
          - **CMS**: Notion
          - **ë°°í¬**: GitHub Pages
          - **CI/CD**: GitHub Actions
          
          ## ğŸ“¬ ì—°ë½ì²˜
          
          - **GitHub**: [@Cybecho](https://github.com/Cybecho)
          
          ---
          *Notion APIë¥¼ í†µí•´ Published ìƒíƒœì˜ ê¸€ë“¤ì´ ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤* âœ¨
          EOF
          fi
          
          # ë©”ì¸ í˜ì´ì§€ (_index.md)
          if [ ! -f content/_index.md ]; then
            mkdir -p content
            cat > content/_index.md << 'EOF'
          ---
          title: "ì‚½ì§ˆ ì €ì¥ì†Œ"
          ---
          
          ## ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”!
          
          ê°œë°œì **Cybecho**ì˜ ì‚½ì§ˆê³¼ í•™ìŠµì„ ê¸°ë¡í•˜ëŠ” ê³µê°„ì…ë‹ˆë‹¤.
          
          ì‹¤íŒ¨ì—ì„œ ë°°ìš°ê³ , ì„±ê³µì„ ê¸°ë¡í•˜ë©°, ì§€ì‹ì„ ê³µìœ í•©ë‹ˆë‹¤.
          
          ### ğŸ¯ ì£¼ìš” ì£¼ì œë“¤
          
          - **ì¸í”„ë¼**: AWS, Kubernetes, Docker, ProxMox
          - **ê°œë°œí™˜ê²½**: Linux, macOS, ê°œë°œë„êµ¬
          - **í•™ìŠµ**: ìƒˆë¡œìš´ ê¸°ìˆ ê³¼ ê°œë… íƒêµ¬
          - **ë¬¸ì œí•´ê²°**: ì‹¤ë¬´ ë¬¸ì œì™€ í•´ê²° ê³¼ì •
          
          ---
          EOF
          fi

      # Hugo ë¹Œë“œ
      - name: Build with Hugo
        env:
          HUGO_ENVIRONMENT: production
        run: |
          echo "ğŸ—ï¸ Building Hugo site..."
          hugo --gc --minify

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
