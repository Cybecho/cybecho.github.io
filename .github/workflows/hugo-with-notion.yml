name: Deploy Hugo with Notion Sync

on:
  push:
    branches: ["main"]
  schedule:
    - cron: '0 2 * * *'  # ë§¤ì¼ ìƒˆë²½ 2ì‹œ Notion ë™ê¸°í™”
  workflow_dispatch:

permissions:
  contents: write  # Notion ì½˜í…ì¸  ì»¤ë°‹ì„ ìœ„í•´ write ê¶Œí•œ í•„ìš”
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      # ðŸš€ Notion ì½˜í…ì¸  ë™ê¸°í™” (í•µì‹¬ ë¶€ë¶„!)
      - name: Install notion-jam
        run: npm install -g notion-jam

      - name: Sync Notion Content
        run: |
          echo "ðŸ”„ Starting Notion sync..."
          echo "Database ID: ${{ secrets.DATABASE_ID }}"
          
          # Notion â†’ Markdown ë³€í™˜
          notion-jam \
            --notion-token "${{ secrets.NOTION_SECRET }}" \
            --root-page "https://www.notion.so/${{ secrets.DATABASE_ID }}" \
            --output-dir "content/posts" \
            --download-images \
            --image-dir "static/images" \
            --slug-format "title" \
            --filter-prop "Status" \
            --filter-values "Published" || echo "âš ï¸ Notion sync had issues, continuing..."

      # Notion ë™ê¸°í™” ê²°ê³¼ í™•ì¸
      - name: Check Notion Content
        run: |
          echo "ðŸ“Š Notion sync results:"
          echo "=== Content directory ==="
          find content -name "*.md" -type f | wc -l
          echo "total markdown files"
          
          echo "=== Sample files ==="
          find content -name "*.md" -type f | head -5
          
          echo "=== Images downloaded ==="
          if [ -d "static/images" ]; then
            ls static/images/ | wc -l
            echo "total images"
          else
            echo "No images directory found"
          fi

      # Notion ì½˜í…ì¸ ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì½˜í…ì¸  ìƒì„±
      - name: Create default content if needed
        run: |
          if [ ! -f content/about.md ]; then
            echo "ðŸ“„ Creating about page..."
            mkdir -p content
            cat > content/about.md << 'EOF'
          ---
          title: "ì†Œê°œ"
          date: 2024-01-01T00:00:00+09:00
          draft: false
          ---

          # ì•ˆë…•í•˜ì„¸ìš”, Cybechoìž…ë‹ˆë‹¤! ðŸ‘‹

          ê°œë°œìžë¡œì„œì˜ ì‚½ì§ˆê³¼ ì„±ìž¥ì„ ê¸°ë¡í•˜ëŠ” ê³µê°„ìž…ë‹ˆë‹¤.

          ## ì´ ë¸”ë¡œê·¸ëŠ”...
          - ðŸ”§ ê°œë°œ ì‚½ì§ˆê¸°  
          - ðŸ“š í•™ìŠµ ë…¸íŠ¸
          - ðŸ’¡ ë¬¸ì œ í•´ê²° ê³¼ì •
          - ðŸš€ ìƒˆë¡œìš´ ê¸°ìˆ  íƒí—˜

          ì„ ë‹¤ë£¹ë‹ˆë‹¤.

          ## ì—°ë½ì²˜
          - **GitHub**: [@Cybecho](https://github.com/Cybecho)
          - **Notion**: [ì‚½ì§ˆ ì €ìž¥ì†Œ ë°ì´í„°ë² ì´ìŠ¤](https://www.notion.so/cybecho/${{ secrets.DATABASE_ID }})

          ---
          *Notionì—ì„œ ìž‘ì„±í•œ ê¸€ë“¤ì´ ìžë™ìœ¼ë¡œ ì—¬ê¸°ì— ë™ê¸°í™”ë©ë‹ˆë‹¤!* âœ¨
          EOF
          fi

          # ë§Œì•½ Notionì—ì„œ ì½˜í…ì¸ ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆë‹¤ë©´ ìƒ˜í”Œ ìƒì„±
          post_count=$(find content/posts -name "*.md" -type f 2>/dev/null | wc -l)
          if [ "$post_count" -eq 0 ]; then
            echo "âš ï¸ No Notion content found, creating sample post..."
            mkdir -p content/posts/notion-sync-guide
            cat > content/posts/notion-sync-guide/index.md << 'EOF'
          ---
          title: "ðŸ”„ Notion ë™ê¸°í™” ì„¤ì • ì™„ë£Œ!"
          date: 2024-01-20T00:00:00+09:00
          draft: false
          tags: ["Notion", "ìžë™í™”", "ë¸”ë¡œê·¸"]
          categories: ["ê¸°ìˆ "]
          summary: "Notion ë°ì´í„°ë² ì´ìŠ¤ì™€ Hugo ë¸”ë¡œê·¸ ìžë™ ë™ê¸°í™”ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!"
          ---

          # Notion ìžë™ ë™ê¸°í™” ì„¤ì • ì™„ë£Œ! ðŸŽ‰

          ì•ˆë…•í•˜ì„¸ìš”! ë“œë””ì–´ **Notion ë°ì´í„°ë² ì´ìŠ¤**ì™€ ì´ Hugo ë¸”ë¡œê·¸ ê°„ì˜ ìžë™ ë™ê¸°í™”ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.

          ## ðŸ”§ í˜„ìž¬ ì„¤ì •

          - **Notion ë°ì´í„°ë² ì´ìŠ¤**: [ì‚½ì§ˆ ì €ìž¥ì†Œ](${{ secrets.DATABASE_ID }})
          - **ìžë™ ë™ê¸°í™”**: ë§¤ì¼ ìƒˆë²½ 2ì‹œ + ì½”ë“œ ë³€ê²½ì‹œ
          - **í•„í„°ë§**: Status = "Published"ì¸ ê¸€ë§Œ ë™ê¸°í™”
          - **ì´ë¯¸ì§€**: ìžë™ ë‹¤ìš´ë¡œë“œ ë° ìµœì í™”

          ## ðŸ“ ì‚¬ìš©ë²•

          1. **Notionì—ì„œ ê¸€ ìž‘ì„±**
          2. **Statusë¥¼ "Published"ë¡œ ë³€ê²½**
          3. **ìžë™ìœ¼ë¡œ ì´ ë¸”ë¡œê·¸ì— ë°˜ì˜** (ìµœëŒ€ 24ì‹œê°„)

          ## ðŸš€ ë‹¤ìŒ ë‹¨ê³„

          - Notionì—ì„œ ì²« ë²ˆì§¸ ê¸€ì„ "Published" ìƒíƒœë¡œ ë³€ê²½í•´ë³´ì„¸ìš”
          - GitHub Actionsì—ì„œ ë™ê¸°í™” ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤
          - ê¶ê¸ˆí•œ ì ì€ GitHub Issuesë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”!

          **Happy Writing!** âœ¨
          EOF
          fi

      # Notion ì½˜í…ì¸  ë³€ê²½ì‚¬í•­ ì»¤ë°‹
      - name: Commit Notion Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "ðŸ“ Changes detected, committing..."
            git add content/ static/images/ || true
            git commit -m "ðŸ”„ Sync Notion content - $(date '+%Y-%m-%d %H:%M')" || true
            git push || echo "Nothing to push"
          else
            echo "âœ… No changes to commit"
          fi

      # Hugo ë¹Œë“œ
      - name: Build with Hugo
        env:
          HUGO_ENVIRONMENT: production
          HUGO_ENV: production
        run: |
          echo "ðŸ—ï¸ Building Hugo site..."
          hugo --gc --minify

      # ë¹Œë“œ ê²°ê³¼ ìµœì¢… í™•ì¸
      - name: Build Summary
        run: |
          echo "ðŸ“Š Build Summary:"
          echo "=== Generated HTML files ==="
          find public -name "*.html" | wc -l
          echo "=== Post pages ==="
          find public/posts -name "*.html" 2>/dev/null | wc -l || echo "0"
          echo "=== Static assets ==="
          find public -name "*.css" -o -name "*.js" -o -name "*.png" -o -name "*.jpg" | wc -l

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
